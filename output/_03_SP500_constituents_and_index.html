
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>HW Guide Part B: Reconstructing the S&amp;P 500 Index &#8212; Full Stack Quantitative Finance</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'output/_03_SP500_constituents_and_index';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Week 3: Task Runners, Automating Queries, and the Basics of SQL" href="../lectures/Week3/overview_w3.html" />
    <link rel="prev" title="HW Guide Part A: CRSP Market Returns Indices" href="_02_CRSP_market_index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Full Stack Quantitative Finance - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Full Stack Quantitative Finance - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Full Stack Quantitative Finance
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Course Syllabus: FINM 32900, Winter 2025</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/Week1/HW0.html">Homework 0: Setting up your computing environment</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week1/overview_w1.html">Week 1: GitHub, GitHub Classroom, and Virtual Environments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week1/what_is_this_course_about.html">What is Full Stack Quantitative Finance? Why This Course?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week1/reproducible_analytical_pipelines.html">What are Reproducible Analytical Pipelines?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week1/case_study_reproducibility_in_finance.html">Case Study: Is There A Reproducibility Crisis In Finance?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week1/virtual_environments.html">Virtual Environments</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week1/HW1.html">Homework 1</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week1/case_study_atlanta_fed_wage_growth_tracker.html">Case Study: Atlanta Fed Wage Growth Tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="_01_wage_growth_during_the_recession.html">HW Guide: Wage Growth During the Recession</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week2/overview_w2.html">Week 2: Env Files and Secrets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week2/WRDS_intro_and_web_queries.html">Introduction to WRDS</a></li>
<li class="toctree-l2"><a class="reference internal" href="_01_wrds_python_package.html">Example: Connecting to the WRDS Platform With Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week2/env_files.html">Env Files, Secrets, and the Separations of Settings from Code</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../lectures/Week2/HW2.html">Homework 2</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="_02_CRSP_market_index.html">HW Guide Part A: CRSP Market Returns Indices</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">HW Guide Part B: Reconstructing the S&amp;P 500 Index</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week3/overview_w3.html">Week 3: Task Runners, Automating Queries, and the Basics of SQL</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week3/what_is_a_task_runner.html">What is a build system or task runner?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week2/project_structure.html">Project Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="_05_basics_of_SQL.html">Basics of SQL</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week4/overview_w4.html">Week 4: Generating Reports, featuring Jupyter Notebooks and LaTeX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week4/reports_with_jupyter_notebooks.html">Reports with Jupyter Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week4/intro_to_LaTeX.html">Introduction to LaTeX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week4/latex_essentials.html">LaTeX Essentials</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/subject_to_change_after_this_week.html">–Schedule subject to change after HERE–</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week3/HW3.html">Homework 3</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="_01_repo_spikes.html">Rate Spikes in the Market for Repurchase Agreements</a></li>



<li class="toctree-l2"><a class="reference internal" href="_04_Fama_French_1993.html">HW Guide Part B: Replicate Fama-French 1993</a></li>



</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week5/overview_w5.html">Week 5: Unit Tests and Documentation with Sphinx</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week5/sphinx.html">Sphinx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week5/unit_tests.html">Unit Tests</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week6/overview_w6.html">Week 6: Bloomberg and Social Coding with GitHub</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week6/bloomberg_terminal.html">The Bloomberg Terminal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week6/GitHub_pull_requests.html">GitHub Pull Requests: Enhancing Collaborative Development</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/Week7/overview_w7.html">Week 7: Reviewing Sphinx and Unit Tests</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Week8/overview_w8.html">Week 8: GitHub Actions and Publishing a Live Dashboard</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Week8/github_actions_interactive_dashboard.html">Creating a Live Dashboard Example with GitHub Actions</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/Week8/HW4.html">Homework 4</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../lectures/Misc/final_project.html">Final Project</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../lectures/Misc/potential_final_projects.html">List of Potential Final Projects</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/Misc/appendix.html">Appendix</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/finm-32900/finm-32900-data-science" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/finm-32900/finm-32900-data-science/issues/new?title=Issue%20on%20page%20%2Foutput/_03_SP500_constituents_and_index.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/output/_03_SP500_constituents_and_index.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>HW Guide Part B: Reconstructing the S&P 500 Index</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-reconstruct-the-s-p-500-index">Why Reconstruct the S&amp;P 500 Index?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#official-s-p-500-index-methodology">Official S&amp;P 500 Index Methodology</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-the-market-capitalization-of-each-constituent-company">1. Determine the Market Capitalization of Each Constituent Company</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjust-the-market-capitalization-for-free-float">2. Adjust the Market Capitalization for Free Float</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-total-market-capitalization-of-the-index">3. Calculate the Total Market Capitalization of the Index</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-divisor">4. Calculate the Divisor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-index-level">5. Calculate the Index Level</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#approximating-the-s-p-500-index-with-data-from-crsp">Approximating the S&amp;P 500 Index with data from CRSP</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-required-for-approximation">Data Required for Approximation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-constituent-data">Load the Constituent Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-crsp-stock-and-index-data">Load the CRSP Stock and Index Data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-a-simple-sum-of-market-caps">Method A: Simple Sum of Market Caps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-b-portfolio-rebalancing">Method B: Portfolio Rebalancing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-the-approximations">Comparing the Approximations</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="hw-guide-part-b-reconstructing-the-s-p-500-index">
<h1>HW Guide Part B: Reconstructing the S&amp;P 500 Index<a class="headerlink" href="#hw-guide-part-b-reconstructing-the-s-p-500-index" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>The <strong>S&amp;P 500 Index</strong> is one of the most well-known benchmarks for the U.S. equity market. It represents the performance of 500 large-cap companies across various industries, serving as a proxy for the overall stock market. Constructing an index of this nature involves aggregation of market data, weighting by market capitalization, and accounting for changes in index membership over time. This lecture introduces the mechanics of the S&amp;P 500 index, provides an overview of its construction, and guides you through a case study on approximating its level and returns using data from CRSP and WRDS. Some of the information needed to perfectly replicate the S&amp;P 500 index is proprietary and not available through WRDS. So, the approximation in the next section will be imperfect. However, it will be close enough. For now, we will use this note to get a better understanding of how the S&amp;P 500 is constructed.</p>
<section id="why-reconstruct-the-s-p-500-index">
<h3>Why Reconstruct the S&amp;P 500 Index?<a class="headerlink" href="#why-reconstruct-the-s-p-500-index" title="Link to this heading">#</a></h3>
<p>Reconstructing the S&amp;P 500 index from its underlying constituents is a valuable exercise for students of quantitative finance. This process:</p>
<ol class="arabic simple">
<li><p><strong>Provides Practical Data Experience</strong>: You’ll gain hands-on experience with downloading and processing real financial data from Wharton Research Data Services (WRDS) and CRSP.</p></li>
<li><p><strong>Develops Insight into Index Construction</strong>: By breaking down the methodology, you will better understand the structure and mechanics of market-capitalization-weighted indices.</p></li>
<li><p><strong>Builds Programming Skills</strong>: The reconstruction process requires advanced data handling, including merging datasets, calculating weights, and implementing rebalancing rules.</p></li>
<li><p><strong>Reveals Approximation Techniques</strong>: As the S&amp;P 500’s official calculation includes proprietary adjustments, this exercise demonstrates how to approximate real-world phenomena using accessible data and mathematical techniques.</p></li>
<li><p><strong>Enhances Quantitative Finance Skills</strong>: The reconstruction builds your ability to analyze returns, index performance, and the impact of portfolio rebalancing.</p></li>
</ol>
</section>
<section id="learning-goals">
<h3>Learning Goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h3>
<p>By the end of this lecture and exercise, you should be able to:</p>
<ul class="simple">
<li><p>Explain the construction methodology of the S&amp;P 500 index.</p></li>
<li><p>Use historical data on index constituents, prices, and shares outstanding to approximate the index.</p></li>
<li><p>Implement two methods for approximating the index:</p>
<ul>
<li><p><strong>Method A</strong>: a simple sum of the market caps of the index’s constituents</p></li>
<li><p><strong>Method B</strong>: an approximation that assumes that a trader forms a porfolio holding the index’s constituents and rebalances the portfolio quarterly.</p></li>
</ul>
</li>
<li><p>Compare your reconstructed index to the actual S&amp;P 500 index by analyzing the correlation of levels and returns.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="official-s-p-500-index-methodology">
<h2>Official S&amp;P 500 Index Methodology<a class="headerlink" href="#official-s-p-500-index-methodology" title="Link to this heading">#</a></h2>
<p>The S&amp;P 500 index contains approximately 500 of the largest publicly traded U.S. companies by market capitalization, selected by the S&amp;P Dow Jones Indices committee based on criteria such as liquidity, profitability, and market size. The index is a <strong>market-capitalization-weighted index</strong>, meaning that each stock in the index is weighted by its market cap. The index is rebalanced quarterly to reflect changes in membership and market values, ensuring it accurately represents the large-cap equity market. Key features of the index include:</p>
<p>A full description of the methodology used to calculate the S&amp;P 500 index is available <a class="reference external" href="https://www.spglobal.com/spdji/en/documents/methodologies/methodology-index-math.pdf">here</a>. However, the following steps provide a simplified overview of the calculation process.</p>
<section id="determine-the-market-capitalization-of-each-constituent-company">
<h3>1. Determine the Market Capitalization of Each Constituent Company<a class="headerlink" href="#determine-the-market-capitalization-of-each-constituent-company" title="Link to this heading">#</a></h3>
<p>The market capitalization of a company represents its total equity value in the stock market. It is determined by multiplying the current market price per share by the total number of outstanding shares.</p>
<div class="math notranslate nohighlight">
\[
  \text{MarketCap}_{i, t} = P_{i,t} \times \text{Shrout}_{i,t},
\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{i,t}\)</span> is the stock price and <span class="math notranslate nohighlight">\(\text{Shrout}_{i,t}\)</span> is the number of shares outstanding.</p>
</section>
<section id="adjust-the-market-capitalization-for-free-float">
<h3>2. Adjust the Market Capitalization for Free Float<a class="headerlink" href="#adjust-the-market-capitalization-for-free-float" title="Link to this heading">#</a></h3>
<p>The S&amp;P 500 utilizes a “free-float market capitalization-weighted methodology”. This method focuses solely on the shares readily available for trading by the public, excluding those held by company insiders or governments. Therefore, the next crucial step involves adjusting the market capitalization to account for the “free float” of each company’s shares. Free float refers to the portion of outstanding shares that are readily available for trading in the open market. This adjustment ensures that the index accurately reflects the true market value of the companies based on the shares that investors can actively buy and sell.</p>
<p>To calculate the free-float market capitalization, an Investable Weight Factor (IWF) is employed. The IWF represents the percentage of a company’s total outstanding shares that are included in the index calculation. It is used to adjust for various factors, including foreign ownership restrictions, that might affect a stock’s actual weight in the index.</p>
<div class="math notranslate nohighlight">
\[
\text{Free-float MarketCap}_{i, t} = \text{MarketCap}_{i, t} \times \text{IWF}_{i},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\text{IWF}_{i}\)</span> represents the proportion of a company’s shares that are freely available for trading.</p>
<p>The IWF is typically expressed as a percentage and is obtained from financial data providers. For example, if 80% of a company’s shares are available for public trading, its IWF would be 0.8.</p>
</section>
<section id="calculate-the-total-market-capitalization-of-the-index">
<h3>3. Calculate the Total Market Capitalization of the Index<a class="headerlink" href="#calculate-the-total-market-capitalization-of-the-index" title="Link to this heading">#</a></h3>
<p>Once the free-float market capitalization is calculated for each company, these values are summed to arrive at the total market capitalization of the S&amp;P 500. This aggregate value serves as the numerator in the index calculation.</p>
<p>The total market cap of the index is</p>
<div class="math notranslate nohighlight">
\[
\text{MarketCapSP500}_{t} = \sum_{i \in \mathcal{I}_{S\&amp;P, t}} \text{MarketCap}_{i, t},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathcal{I}_{S\&amp;P, t}\)</span> represents the set of constituents at time <span class="math notranslate nohighlight">\(t\)</span>.</p>
</section>
<section id="calculate-the-divisor">
<h3>4. Calculate the Divisor<a class="headerlink" href="#calculate-the-divisor" title="Link to this heading">#</a></h3>
<p>The divisor is a critical element in the S&amp;P 500 calculation. It is a proprietary value determined by S&amp;P Dow Jones Indices and is used to scale the index down to a more manageable and reportable level. The divisor is subject to adjustments over time to account for various corporate actions that could influence the index’s value. These actions include:</p>
<ul class="simple">
<li><p><strong>Stock Splits:</strong> When a company splits its stock, the number of outstanding shares increases, while the price per share decreases proportionally. The divisor is adjusted to prevent this corporate action from artificially impacting the index level.</p></li>
<li><p><strong>Dividends:</strong> While regular cash dividends do not directly affect the index level, special dividends, which are larger, one-time distributions, can influence the divisor.</p></li>
<li><p><strong>Spinoffs:</strong> When a company spins off a subsidiary into a separate publicly traded entity, the divisor is adjusted to reflect the change in the index’s composition.</p></li>
<li><p><strong>Index Reconstitution:</strong> The S&amp;P 500 periodically adds or removes companies to ensure it continues to represent the leading U.S. equities. These changes also necessitate adjustments to the divisor.</p></li>
</ul>
<p>The divisor plays a crucial role in maintaining the index’s continuity over time. The divisor adjustment process ensures that these actions do not introduce artificial jumps or drops in the index level.
By adjusting for corporate actions and changes in the index’s constituents, the divisor ensures that the S&amp;P 500 remains a consistent and reliable benchmark for tracking the performance of the U.S. equity market. The formula for the divisor adjustment depends on the specific corporate action and is detailed in S&amp;P Dow Jones Indices’ methodology documents (see <a class="reference external" href="https://www.spglobal.com/spdji/en/documents/methodologies/methodology-index-math.pdf">S&amp;P Dow Jones Indices’ Index Mathematics Methodology</a>).</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Corporate Action</p></th>
<th class="head"><p>Impact on Divisor</p></th>
<th class="head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Stock Split</strong></p></td>
<td><p>Adjusted to maintain index continuity</p></td>
<td><p>A 2-for-1 stock split doubles shares but halves the price.</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Special Dividend</strong></p></td>
<td><p>Adjusted to account for the distribution</p></td>
<td><p>A one-time dividend reduces market capitalization.</p></td>
</tr>
<tr class="row-even"><td><p><strong>Spinoff</strong></p></td>
<td><p>Adjusted to reflect the spun-off entity’s market cap</p></td>
<td><p>A parent company spins off a subsidiary as a new company.</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Index Reconstitution</strong></p></td>
<td><p>Adjusted for additions/removals in the index</p></td>
<td><p>A new company is added, requiring a reweighting of constituents.</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="calculate-the-index-level">
<h3>5. Calculate the Index Level<a class="headerlink" href="#calculate-the-index-level" title="Link to this heading">#</a></h3>
<p>Finally, the S&amp;P 500 index level is calculated as:</p>
<div class="math notranslate nohighlight">
\[
\text{Index Level}_{t} = \frac{1}{\text{Divisor}_{t}} \times \sum_{i \in \mathcal{I}_{S\&amp;P, t}} P_{i,t} \times \text{Free-float Shrout}_{i,t},
\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{i,t}\)</span> is the stock price of company <span class="math notranslate nohighlight">\(i\)</span> at time <span class="math notranslate nohighlight">\(t\)</span>, <span class="math notranslate nohighlight">\(\text{Free-float Shrout}_{i,t}\)</span> is the number of freely traded shares of company <span class="math notranslate nohighlight">\(i\)</span> at time <span class="math notranslate nohighlight">\(t\)</span>, and <span class="math notranslate nohighlight">\(\text{Divisor}\)</span> is the proprietary scaling factor.</p>
<p>This formula aggregates the weighted market capitalizations of all constituents, scaled by the divisor to produce the reported index level.</p>
</section>
</section>
<hr class="docutils" />
<section id="approximating-the-s-p-500-index-with-data-from-crsp">
<h2>Approximating the S&amp;P 500 Index with data from CRSP<a class="headerlink" href="#approximating-the-s-p-500-index-with-data-from-crsp" title="Link to this heading">#</a></h2>
<p>As discussed in the introduction, the S&amp;P 500 index is a proprietary calculation and not available through WRDS. However, we can approximate the index level and returns using data from CRSP. Here, we will implement two methods for approximating the index:</p>
<ul class="simple">
<li><p><strong>Method A</strong>: a simple sum of the market caps of the index’s constituents</p></li>
<li><p><strong>Method B</strong>: an approximation that assumes that a trader forms a porfolio holding the index’s constituents and rebalances the portfolio quarterly.
We will then compare the reconstructed index to the actual S&amp;P 500 index by analyzing the correlation of levels and returns.</p></li>
</ul>
<section id="data-required-for-approximation">
<h3>Data Required for Approximation<a class="headerlink" href="#data-required-for-approximation" title="Link to this heading">#</a></h3>
<p>To reconstruct the S&amp;P 500 index, we need:</p>
<ol class="arabic simple">
<li><p><strong>Constituent Data</strong>: Membership data indicating which stocks were part of the index at each point in time.</p></li>
<li><p><strong>Price and Shares Outstanding Data</strong>: Stock-level data to calculate market capitalizations.</p></li>
<li><p><strong>Index Level and Return Data</strong>: Official S&amp;P 500 data for comparison and normalization.</p></li>
</ol>
<p>Data on the historical constituents of the S&amp;P 500 is available through WRDS, while price and shares outstanding data can be accessed through CRSP.</p>
<p>Let’s explore that data now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">wrds</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">pull_CRSP_stock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pull_SP500_constituents</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calc_SP500_index</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>

<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;DATA_DIR&quot;</span><span class="p">)</span>
<span class="n">WRDS_USERNAME</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;WRDS_USERNAME&quot;</span><span class="p">)</span>
<span class="n">START_DATE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;1960-01-01&quot;</span><span class="p">)</span>
<span class="n">END_DATE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2023-12-29&quot;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="load-the-constituent-data">
<h4>Load the Constituent Data<a class="headerlink" href="#load-the-constituent-data" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">wrds</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">wrds_username</span><span class="o">=</span><span class="n">WRDS_USERNAME</span><span class="p">)</span>
<span class="n">df_constituents</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; </span>
<span class="s2">select *  </span>
<span class="s2">from crsp_m_indexes.dsp500list_v2 </span>
<span class="s2">-- limit 2000  </span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># Convert string columns to datetime if they aren&#39;t already</span>
<span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrstartdt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrstartdt&quot;</span><span class="p">])</span>
<span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrenddt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrenddt&quot;</span><span class="p">])</span>
<span class="n">df_constituents</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading library list...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permno</th>
      <th>indno</th>
      <th>mbrstartdt</th>
      <th>mbrenddt</th>
      <th>mbrflg</th>
      <th>indfam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10006</td>
      <td>1000500</td>
      <td>1957-03-01</td>
      <td>1984-07-18</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10030</td>
      <td>1000500</td>
      <td>1957-03-01</td>
      <td>1969-01-08</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10049</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>1932-10-01</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10057</td>
      <td>1000500</td>
      <td>1957-03-01</td>
      <td>1992-07-02</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10078</td>
      <td>1000500</td>
      <td>1992-08-20</td>
      <td>2010-01-28</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_constituents</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 2064 entries, 0 to 2063
Data columns (total 6 columns):
 #   Column      Non-Null Count  Dtype         
---  ------      --------------  -----         
 0   permno      2064 non-null   int64         
 1   indno       2064 non-null   int64         
 2   mbrstartdt  2064 non-null   datetime64[ns]
 3   mbrenddt    2064 non-null   datetime64[ns]
 4   mbrflg      2064 non-null   object        
 5   indfam      2064 non-null   int64         
dtypes: datetime64[ns](2), int64(3), object(1)
memory usage: 96.9+ KB
</pre></div>
</div>
</div>
</div>
<p>Dictionary of columns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">permno</span></code>, <em>int64</em>:  Permno of the constituent, where a permno is a unique identifier for a stock issued by CRSP.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">indno</span></code>, <em>int64</em>:  Index number of the constituent, where the index number is a unique identifier for the S&amp;P 500 index.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mbrstartdt</span></code>, <em>object</em>:  Membership start date of the constituent in the S&amp;P 500 index.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mbrenddt</span></code>, <em>object</em>:  Membership end date of the constituent in the S&amp;P 500 index.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mbrflg</span></code>, <em>object</em>:  Membership flag of the constituent in the S&amp;P 500 index.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">indfam</span></code>, <em>int64</em>:  Index family of the constituent, where the index family is a unique identifier for the S&amp;P 500 index.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_constituents</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permno</th>
      <th>indno</th>
      <th>mbrstartdt</th>
      <th>mbrenddt</th>
      <th>indfam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>2064.000000</td>
      <td>2064.0</td>
      <td>2064</td>
      <td>2064</td>
      <td>2064.0</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>42298.498547</td>
      <td>1000500.0</td>
      <td>1981-11-04 14:12:33.488372160</td>
      <td>1999-08-27 01:57:54.418604672</td>
      <td>1100500.0</td>
    </tr>
    <tr>
      <th>min</th>
      <td>10006.000000</td>
      <td>1000500.0</td>
      <td>1925-12-31 00:00:00</td>
      <td>1928-08-24 00:00:00</td>
      <td>1100500.0</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>18249.750000</td>
      <td>1000500.0</td>
      <td>1957-03-01 00:00:00</td>
      <td>1982-06-02 00:00:00</td>
      <td>1100500.0</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>28484.000000</td>
      <td>1000500.0</td>
      <td>1982-10-31 12:00:00</td>
      <td>2001-12-13 00:00:00</td>
      <td>1100500.0</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>68657.500000</td>
      <td>1000500.0</td>
      <td>2002-07-22 00:00:00</td>
      <td>2024-04-10 18:00:00</td>
      <td>1100500.0</td>
    </tr>
    <tr>
      <th>max</th>
      <td>93436.000000</td>
      <td>1000500.0</td>
      <td>2024-12-23 00:00:00</td>
      <td>2024-12-31 00:00:00</td>
      <td>1100500.0</td>
    </tr>
    <tr>
      <th>std</th>
      <td>27679.821158</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;permno&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1936
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrflg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mbrflg
NORM    2064
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># There is only one index family for all the constituents.</span>
<span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;indfam&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>indfam
1100500    2064
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># There is only one index number for all the constituents.</span>
<span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;indno&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>indno
1000500    2064
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## Constituents at a given date</span>
<span class="n">mydate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2019-03-01&quot;</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrstartdt&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mydate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
    <span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrenddt&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mydate</span>
<span class="p">)</span>
<span class="n">constituents</span> <span class="o">=</span> <span class="n">df_constituents</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mbrstartdt&quot;</span><span class="p">,</span> <span class="s2">&quot;mbrenddt&quot;</span><span class="p">])</span>
<span class="n">constituents</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permno</th>
      <th>indno</th>
      <th>mbrstartdt</th>
      <th>mbrenddt</th>
      <th>mbrflg</th>
      <th>indfam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>353</th>
      <td>15069</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-11-25</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10145</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>102</th>
      <td>11404</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>117</th>
      <td>11674</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>130</th>
      <td>11850</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1990</th>
      <td>90520</td>
      <td>1000500</td>
      <td>2018-12-24</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>170</th>
      <td>12448</td>
      <td>1000500</td>
      <td>2019-01-02</td>
      <td>2023-05-03</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>1219</th>
      <td>44329</td>
      <td>1000500</td>
      <td>2019-01-18</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>1067</th>
      <td>32986</td>
      <td>1000500</td>
      <td>2019-02-15</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>1768</th>
      <td>81677</td>
      <td>1000500</td>
      <td>2019-02-27</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
  </tbody>
</table>
<p>505 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## Notice that the constituents change at the end of March.</span>
<span class="n">mydate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2019-04-01&quot;</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrstartdt&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mydate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
    <span class="n">df_constituents</span><span class="p">[</span><span class="s2">&quot;mbrenddt&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mydate</span>
<span class="p">)</span>
<span class="n">constituents</span> <span class="o">=</span> <span class="n">df_constituents</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mbrstartdt&quot;</span><span class="p">,</span> <span class="s2">&quot;mbrenddt&quot;</span><span class="p">])</span>
<span class="n">constituents</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permno</th>
      <th>indno</th>
      <th>mbrstartdt</th>
      <th>mbrenddt</th>
      <th>mbrflg</th>
      <th>indfam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>353</th>
      <td>15069</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-11-25</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10145</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>102</th>
      <td>11404</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>117</th>
      <td>11674</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>130</th>
      <td>11850</td>
      <td>1000500</td>
      <td>1925-12-31</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1219</th>
      <td>44329</td>
      <td>1000500</td>
      <td>2019-01-18</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>1067</th>
      <td>32986</td>
      <td>1000500</td>
      <td>2019-02-15</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>1768</th>
      <td>81677</td>
      <td>1000500</td>
      <td>2019-02-27</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>528</th>
      <td>18420</td>
      <td>1000500</td>
      <td>2019-03-19</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
    <tr>
      <th>529</th>
      <td>18421</td>
      <td>1000500</td>
      <td>2019-03-19</td>
      <td>2024-12-31</td>
      <td>NORM</td>
      <td>1100500</td>
    </tr>
  </tbody>
</table>
<p>505 rows × 6 columns</p>
</div></div></div>
</div>
</section>
<section id="load-the-crsp-stock-and-index-data">
<h4>Load the CRSP Stock and Index Data<a class="headerlink" href="#load-the-crsp-stock-and-index-data" title="Link to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">df_msf</span></code> is the CRSP monthly stock file. This file contains the price and shares outstanding data for all stocks in the CRSP database.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">permno</span></code>: Permno of the stock, which is a unique identifier for a stock issued by CRSP.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">date</span></code>: Date of the observation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prc</span></code>: Price of the stock.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shrout</span></code>: Shares outstanding of the stock.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exchcd</span></code>: Exchange code of the stock.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shrcd</span></code>: Share code of the stock.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">siccd</span></code>: Standard Industrial Classification code of the stock.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cfacshr</span></code>: Cumulative adjustment factor for shares outstanding. This adjust, e.g., for stock splits.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cfacpr</span></code>: Cumulative adjustment factor for price. This adjust, e.g., for stock splits.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ret</span></code>: Return of the stock, including dividends.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">retx</span></code>: Return of the stock, excluding dividends.</p></li>
</ul>
<p>The cumulative adjustment factors are used to adjust for corporate actions that affect the stock price, such as stock splits. So</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;adj_shrout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;shrout&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;cfacshr&quot;</span><span class="p">]</span>
<span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;adj_prc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;prc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;cfacpr&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Total market cap is then</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;market_cap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;adj_prc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_msf</span><span class="p">[</span><span class="s2">&quot;adj_shrout&quot;</span><span class="p">]</span><span class="o">.</span>
</pre></div>
</div>
<p>Note that the price is converted to an absolute value because CRSP reports negative prices when price data is missing and quote data is used in its place. Negative prices indicate that CRSP has used the midpoint of the bid-ask spread as the price. Since we don’t mind using quote data or price data, we can safely convert the price to an absolute value.</p>
<p>Also, as an additional note, CRSP reports that “cfacshr” and “cfacpr” are not always equal. This means that we cannot use <code class="docutils literal notranslate"><span class="pre">market_cap</span></code> = <code class="docutils literal notranslate"><span class="pre">prc</span></code> * <code class="docutils literal notranslate"><span class="pre">shrout</span></code> alone. We need to use the cumulative adjustment factors to adjust for corporate actions that affect the stock price, such as stock splits. “cfacshr” and “cfacpr” are not always equal because of less common distribution events, spinoffs, and rights. See here: <a class="reference external" href="https://vimeo.com/443061703">CRSP - Useful Variables</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_msf</span> <span class="o">=</span> <span class="n">pull_CRSP_stock</span><span class="o">.</span><span class="n">load_CRSP_monthly_file</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">DATA_DIR</span><span class="p">)</span>
<span class="n">df_msix</span> <span class="o">=</span> <span class="n">pull_CRSP_stock</span><span class="o">.</span><span class="n">load_CRSP_index_files</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">DATA_DIR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_msf</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 3697390 entries, 0 to 197389
Data columns (total 23 columns):
 #   Column      Dtype         
---  ------      -----         
 0   date        datetime64[ns]
 1   permno      int64         
 2   permco      int64         
 3   shrcd       int64         
 4   exchcd      int64         
 5   comnam      object        
 6   shrcls      object        
 7   ret         float64       
 8   retx        float64       
 9   dlret       float64       
 10  dlretx      float64       
 11  dlstcd      float64       
 12  prc         float64       
 13  altprc      float64       
 14  vol         float64       
 15  shrout      float64       
 16  cfacshr     float64       
 17  cfacpr      float64       
 18  naics       object        
 19  siccd       int64         
 20  adj_shrout  float64       
 21  adj_prc     float64       
 22  market_cap  float64       
dtypes: datetime64[ns](1), float64(14), int64(5), object(3)
memory usage: 677.0+ MB
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">df_msix</span></code> is the CRSP monthly index file. This file contains the return and level of the S&amp;P 500 index.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">caldt</span></code>: Date of the observation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sprtrn</span></code>: Return of the S&amp;P 500 index.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spindx</span></code>: Level of the S&amp;P 500 index.</p></li>
</ul>
<p>This dataframe also contains information about the CRSP value-weighted index and equal-weighted index, along with the 10 deciles of the CRSP market cap index:
((Monthly)NYSE/AMEX/NASDAQ Capitalization Deciles, Annual Rebalanced (msix)) <a class="reference external" href="https://wrds-www.wharton.upenn.edu/data-dictionary/crsp_a_indexes/msix/">https://wrds-www.wharton.upenn.edu/data-dictionary/crsp_a_indexes/msix/</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_msix</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 696 entries, 0 to 695
Data columns (total 35 columns):
 #   Column    Non-Null Count  Dtype         
---  ------    --------------  -----         
 0   caldt     696 non-null    datetime64[ns]
 1   vwretd    696 non-null    float64       
 2   vwindd    696 non-null    float64       
 3   vwretx    696 non-null    float64       
 4   vwindx    696 non-null    float64       
 5   ewretd    696 non-null    float64       
 6   ewindd    696 non-null    float64       
 7   ewretx    696 non-null    float64       
 8   ewindx    696 non-null    float64       
 9   sprtrn    696 non-null    float64       
 10  spindx    696 non-null    float64       
 11  decret1   696 non-null    float64       
 12  decind1   696 non-null    float64       
 13  decret2   696 non-null    float64       
 14  decind2   696 non-null    float64       
 15  decret3   696 non-null    float64       
 16  decind3   696 non-null    float64       
 17  decret4   696 non-null    float64       
 18  decind4   696 non-null    float64       
 19  decret5   696 non-null    float64       
 20  decind5   696 non-null    float64       
 21  decret6   696 non-null    float64       
 22  decind6   696 non-null    float64       
 23  decret7   696 non-null    float64       
 24  decind7   696 non-null    float64       
 25  decret8   696 non-null    float64       
 26  decind8   696 non-null    float64       
 27  decret9   696 non-null    float64       
 28  decind9   696 non-null    float64       
 29  decret10  696 non-null    float64       
 30  decind10  696 non-null    float64       
 31  totval    696 non-null    float64       
 32  totcnt    696 non-null    int64         
 33  usdval    696 non-null    float64       
 34  usdcnt    696 non-null    int64         
dtypes: datetime64[ns](1), float64(32), int64(2)
memory usage: 190.4 KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_msix</span><span class="p">[[</span><span class="s2">&quot;caldt&quot;</span><span class="p">,</span> <span class="s2">&quot;sprtrn&quot;</span><span class="p">,</span> <span class="s2">&quot;spindx&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>caldt</th>
      <th>sprtrn</th>
      <th>spindx</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>691</th>
      <td>2022-08-31</td>
      <td>-0.042440</td>
      <td>3955.00</td>
    </tr>
    <tr>
      <th>692</th>
      <td>2022-09-30</td>
      <td>-0.093396</td>
      <td>3585.62</td>
    </tr>
    <tr>
      <th>693</th>
      <td>2022-10-31</td>
      <td>0.079864</td>
      <td>3871.98</td>
    </tr>
    <tr>
      <th>694</th>
      <td>2022-11-30</td>
      <td>0.053753</td>
      <td>4080.11</td>
    </tr>
    <tr>
      <th>695</th>
      <td>2022-12-30</td>
      <td>-0.058972</td>
      <td>3839.50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="method-a-simple-sum-of-market-caps">
<h3>Method A: Simple Sum of Market Caps<a class="headerlink" href="#method-a-simple-sum-of-market-caps" title="Link to this heading">#</a></h3>
<ol class="arabic">
<li><p><strong>Market Cap Calculation</strong>: For each stock in the index, compute the market capitalization as:</p>
<div class="math notranslate nohighlight">
\[\text{MarketCap}_{i, t} = P_{i,t} \times \text{Shrout}_{i,t}.\]</div>
<p>The total market cap of the index is:</p>
<div class="math notranslate nohighlight">
\[\text{MarketCapSP500}_{t} = \sum_{i \in \mathcal{I}_{S\&amp;P, t}} \text{MarketCap}_{i, t},\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathcal{I}_{S\&amp;P, t}\)</span> represents the set of constituents at time <span class="math notranslate nohighlight">\(t\)</span>.</p>
</li>
<li><p><strong>Index Level Approximation</strong>: Using the market cap ratio, calculate the approximated index level:</p>
<div class="math notranslate nohighlight">
\[\text{IndexLevelApproxA}_{t} = \frac{\text{MarketCapSP500}_{t}}{\text{MarketCapSP500}_{t-1}} \times \text{IndexLevelApproxA}_{t-1}. \]</div>
<p>Normalize <span class="math notranslate nohighlight">\(\text{IndexLevelApproxA}\)</span> at the start date to match the actual S&amp;P 500 level.</p>
</li>
<li><p><strong>Return Approximation</strong>: Calculate the returns as:</p>
<div class="math notranslate nohighlight">
\[R_{A, t} = \frac{\text{IndexLevelApproxA}_{t}}{\text{IndexLevelApproxA}_{t-1}} - 1.\]</div>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sp500_total_market_cap</span> <span class="o">=</span> <span class="n">calc_SP500_index</span><span class="o">.</span><span class="n">calculate_sp500_total_market_cap</span><span class="p">(</span>
    <span class="n">df_constituents</span><span class="p">,</span> <span class="n">df_msf</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sp500_total_market_cap</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sp500_market_cap</th>
      <th>n_constituents</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>691</th>
      <td>2022-08-31</td>
      <td>3.262008e+13</td>
      <td>447</td>
    </tr>
    <tr>
      <th>692</th>
      <td>2022-09-30</td>
      <td>2.958372e+13</td>
      <td>445</td>
    </tr>
    <tr>
      <th>693</th>
      <td>2022-10-31</td>
      <td>3.190338e+13</td>
      <td>447</td>
    </tr>
    <tr>
      <th>694</th>
      <td>2022-11-30</td>
      <td>3.349734e+13</td>
      <td>447</td>
    </tr>
    <tr>
      <th>695</th>
      <td>2022-12-30</td>
      <td>3.144081e+13</td>
      <td>447</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sp500_total_market_cap</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sp500_market_cap&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;date&#39;, ylabel=&#39;sp500_market_cap&#39;&gt;
</pre></div>
</div>
<img alt="../_images/36959a965ec79bdc5488da5fdac6e77ca46d418d5f526105f28182ee4ef544d5.png" src="../_images/36959a965ec79bdc5488da5fdac6e77ca46d418d5f526105f28182ee4ef544d5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sp500_total_market_cap_and_returns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">calc_SP500_index</span><span class="o">.</span><span class="n">append_actual_sp500_index_and_approx_returns_A</span><span class="p">(</span>
        <span class="n">sp500_total_market_cap</span><span class="p">,</span> <span class="n">df_msix</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">sp500_total_market_cap_and_returns</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 696 entries, 0 to 695
Data columns (total 9 columns):
 #   Column                 Non-Null Count  Dtype         
---  ------                 --------------  -----         
 0   date                   696 non-null    datetime64[ns]
 1   spindx                 696 non-null    float64       
 2   sprtrn                 696 non-null    float64       
 3   sp500_market_cap       696 non-null    float64       
 4   n_constituents         696 non-null    int64         
 5   sp500_market_cap_norm  696 non-null    float64       
 6   ret_approx_A           695 non-null    float64       
 7   cumret_approx_A        695 non-null    float64       
 8   sp500_cumret           696 non-null    float64       
dtypes: datetime64[ns](1), float64(7), int64(1)
memory usage: 49.1 KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot cumulative returns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">sp500_total_market_cap_and_returns</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cumret_approx_A&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cumulative Return (Approximation A)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">sp500_total_market_cap_and_returns</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sp500_cumret&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cumulative Return (S&amp;P 500)&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;S&amp;P 500: Cumulative Returns Comparison&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative Return (1 = Initial Value)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/869b35de0369798d98ba27b49ba0e85931bd2d4674b566543ca19be1541f8e78.png" src="../_images/869b35de0369798d98ba27b49ba0e85931bd2d4674b566543ca19be1541f8e78.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print correlation of returns</span>
<span class="n">correlation</span> <span class="o">=</span> <span class="n">sp500_total_market_cap_and_returns</span><span class="p">[</span><span class="s2">&quot;ret_approx_A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span>
    <span class="n">sp500_total_market_cap_and_returns</span><span class="p">[</span><span class="s2">&quot;sprtrn&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation between returns: </span><span class="si">{</span><span class="n">correlation</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation between returns: 0.9921
</pre></div>
</div>
</div>
</div>
<p>Notice that the difference in the cumulative returns is quite large by the end of the sample. However, the correlation between the returns is quite high (over 0.99). This
just shows the consequences of compounding small differences over a long period of time.</p>
<p>Part of the reason why these series are so different is that the approximation method does not account for quarterly rebalancing.</p>
<p>This method assumes that the index composition remains fixed and does not account for quarterly rebalancing. Also, this method does not represent a tradable portfolio strategy. When a stock is removed from the index and a new stock is added, this represents selling a stock that has since dropped in value and buying a new stock that has since increased in value. The returns of the index should represent the fact that a self-financing portfolio strategy is used, and this method does not represent this. The next method does.</p>
</section>
<hr class="docutils" />
<section id="method-b-portfolio-rebalancing">
<h3>Method B: Portfolio Rebalancing<a class="headerlink" href="#method-b-portfolio-rebalancing" title="Link to this heading">#</a></h3>
<p>This method assumes that a trader forms a porfolio holding the index’s constituents and rebalances the portfolio quarterly. Let’s assume that the total amount of money in the portfolio at the beginning of the period is 1 (e.g. $1 million). Then, assume that at each rebalancing date (in this case, quarterly), the trader buys and sells stocks such that the portfolio weights are equal to the weights of the index’s constituents with respect to the ratio of the market cap of each stock to the total market cap of the index.</p>
<ol class="arabic">
<li><p><strong>Weight Calculation</strong>: For each stock <span class="math notranslate nohighlight">\(i\)</span>, calculate its weight in the index:</p>
<div class="math notranslate nohighlight">
\[\begin{split}w_{i, t} = \begin{cases} \frac{\text{MarketCap}_{i, t}}{\text{MarketCapSP500}_{t}} &amp; \text{if } i \in \mathcal{I}_{S\&amp;P, t} \\ 0 &amp; \text{otherwise} \end{cases}\end{split}\]</div>
</li>
<li><p><strong>Portfolio Rebalancing</strong>: Implement quarterly rebalancing. The portfolio weights <span class="math notranslate nohighlight">\(w^p_{i, t}\)</span> are given by
$<span class="math notranslate nohighlight">\( w^p_{i, t} = \begin{cases} w_{i, t} &amp; \text{if } t \text{ is a rebalancing date}, \\ w^p_{i, t-1} &amp; \text{otherwise},\end{cases} \)</span><span class="math notranslate nohighlight">\(
for all \)</span>i<span class="math notranslate nohighlight">\( and \)</span>t$.</p></li>
<li><p><strong>Return Approximation</strong>: Calculate the portfolio return as:</p>
<div class="math notranslate nohighlight">
\[ R_{B, t+1} = \sum_{i} w^p_{i, t} \times R_{i, t+1}, \]</div>
<p>where <span class="math notranslate nohighlight">\(R_{i, t+1}\)</span> is the return of stock <span class="math notranslate nohighlight">\(i\)</span> between <span class="math notranslate nohighlight">\(t\)</span> and <span class="math notranslate nohighlight">\(t+1\)</span>.</p>
</li>
<li><p><strong>Index Level Approximation</strong>: Use the approximated returns to calculate the index level, normalized to match the official S&amp;P 500 at the start date.</p></li>
</ol>
<p><strong>IMPORTANT</strong>: To make this method work as accurately as possible, use the <code class="docutils literal notranslate"><span class="pre">retx</span></code> variable for <span class="math notranslate nohighlight">\(R_{i, t+1}\)</span>. This is because the <code class="docutils literal notranslate"><span class="pre">ret</span></code> variable includes dividends, which are not part of the S&amp;P 500 index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sp500_returns_B</span> <span class="o">=</span> <span class="n">calc_SP500_index</span><span class="o">.</span><span class="n">calculate_sp500_returns_with_rebalancing</span><span class="p">(</span>
    <span class="n">df_constituents</span><span class="p">,</span> <span class="n">df_msf</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">START_DATE</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">END_DATE</span>
<span class="p">)</span>
<span class="n">df_msix</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_msix</span><span class="p">[</span><span class="s2">&quot;caldt&quot;</span><span class="p">])</span>
<span class="n">sp500_returns_B</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df_msix</span><span class="p">[[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;spindx&quot;</span><span class="p">,</span> <span class="s2">&quot;sprtrn&quot;</span><span class="p">]],</span>
    <span class="n">sp500_returns_B</span><span class="p">,</span>
    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;ret_approx_B&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;sprtrn&quot;</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sp500_returns_B</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rebalanced Portfolio&quot;</span><span class="p">)</span>
<span class="n">sp500_returns_B</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>spindx</th>
      <th>sprtrn</th>
      <th>ret_approx_B</th>
      <th>diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>696</td>
      <td>696.000000</td>
      <td>696.000000</td>
      <td>696.000000</td>
      <td>696.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1994-01-13 21:55:51.724137984</td>
      <td>915.805086</td>
      <td>0.006457</td>
      <td>0.006465</td>
      <td>0.000008</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1965-01-29 00:00:00</td>
      <td>63.540000</td>
      <td>-0.217630</td>
      <td>-0.217352</td>
      <td>-0.009691</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1979-07-23 00:00:00</td>
      <td>109.477500</td>
      <td>-0.018313</td>
      <td>-0.018589</td>
      <td>-0.000924</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1994-01-15 12:00:00</td>
      <td>457.380000</td>
      <td>0.009219</td>
      <td>0.009779</td>
      <td>-0.000043</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2008-07-07 18:00:00</td>
      <td>1320.312500</td>
      <td>0.035196</td>
      <td>0.034665</td>
      <td>0.000922</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2022-12-30 00:00:00</td>
      <td>4766.180000</td>
      <td>0.163047</td>
      <td>0.163577</td>
      <td>0.014773</td>
    </tr>
    <tr>
      <th>std</th>
      <td>NaN</td>
      <td>1014.371904</td>
      <td>0.043708</td>
      <td>0.043708</td>
      <td>0.001965</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/a494010c00ece80d76673b75b6aafad250c71a27ae35e3bd8ea423729a6c1177.png" src="../_images/a494010c00ece80d76673b75b6aafad250c71a27ae35e3bd8ea423729a6c1177.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print correlation</span>
<span class="n">correlation</span> <span class="o">=</span> <span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;ret_approx_B&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;sprtrn&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation between reconstructed and actual returns: </span><span class="si">{</span><span class="n">correlation</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation between reconstructed and actual returns: 0.9990
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate cumulative returns</span>
<span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;cumret_approx_B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;ret_approx_B&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
<span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;cumret_actual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sp500_returns_B</span><span class="p">[</span><span class="s2">&quot;sprtrn&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

<span class="c1"># Plot cumulative returns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">sp500_returns_B</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cumret_approx_B&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cumulative Return (Rebalanced Portfolio)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">sp500_returns_B</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cumret_actual&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cumulative Return (S&amp;P 500)&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;S&amp;P 500: Cumulative Returns with Quarterly Rebalancing&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative Return (1 = Initial Value)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4115b0e3fb944e78afbd0a297a1f264b102298d3374f2a20fd98a086d4a380e4.png" src="../_images/4115b0e3fb944e78afbd0a297a1f264b102298d3374f2a20fd98a086d4a380e4.png" />
</div>
</div>
<p>Above we can now see that the cumulative returns are very similar. The correlation between the returns is even higher (over 0.998).</p>
</section>
<hr class="docutils" />
<section id="comparing-the-approximations">
<h3>Comparing the Approximations<a class="headerlink" href="#comparing-the-approximations" title="Link to this heading">#</a></h3>
<p>Once both methods are implemented, compare the reconstructed index to the actual S&amp;P 500 by:</p>
<ol class="arabic simple">
<li><p><strong>Correlation of Returns</strong>: Measure the correlation between the approximated returns and the official S&amp;P 500 returns.</p></li>
<li><p><strong>Index Level Alignment</strong>: Plot the approximated index levels against the official levels to assess how well each method tracks the S&amp;P 500 over time.</p></li>
<li><p><strong>Impact of Rebalancing</strong>: Analyze how quarterly rebalancing affects the accuracy of the reconstruction.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## Function that merges all results together</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">calc_SP500_index</span><span class="o">.</span><span class="n">create_sp500_index_approximations</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">DATA_DIR</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 696 entries, 0 to 695
Data columns (total 10 columns):
 #   Column                 Non-Null Count  Dtype         
---  ------                 --------------  -----         
 0   date                   696 non-null    datetime64[ns]
 1   spindx                 696 non-null    float64       
 2   sprtrn                 696 non-null    float64       
 3   sp500_market_cap       696 non-null    float64       
 4   n_constituents         696 non-null    int64         
 5   sp500_market_cap_norm  696 non-null    float64       
 6   ret_approx_A           695 non-null    float64       
 7   cumret_approx_A        695 non-null    float64       
 8   sp500_cumret           696 non-null    float64       
 9   ret_approx_B           695 non-null    float64       
dtypes: datetime64[ns](1), float64(8), int64(1)
memory usage: 54.5 KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;sprtrn&quot;</span><span class="p">,</span> <span class="s2">&quot;ret_approx_A&quot;</span><span class="p">,</span> <span class="s2">&quot;ret_approx_B&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sprtrn</th>
      <th>ret_approx_A</th>
      <th>ret_approx_B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sprtrn</th>
      <td>1.000000</td>
      <td>0.992116</td>
      <td>0.998989</td>
    </tr>
    <tr>
      <th>ret_approx_A</th>
      <td>0.992116</td>
      <td>1.000000</td>
      <td>0.991552</td>
    </tr>
    <tr>
      <th>ret_approx_B</th>
      <td>0.998989</td>
      <td>0.991552</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Above we saw that the rebalanced portfolio method is more accurate than the simple sum of market caps method. The cumulative returns are much more similar and the correlation between the returns is higher.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./output"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="_02_CRSP_market_index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">HW Guide Part A: CRSP Market Returns Indices</p>
      </div>
    </a>
    <a class="right-next"
       href="../lectures/Week3/overview_w3.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Week 3: Task Runners, Automating Queries, and the Basics of SQL</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-reconstruct-the-s-p-500-index">Why Reconstruct the S&amp;P 500 Index?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#official-s-p-500-index-methodology">Official S&amp;P 500 Index Methodology</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-the-market-capitalization-of-each-constituent-company">1. Determine the Market Capitalization of Each Constituent Company</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjust-the-market-capitalization-for-free-float">2. Adjust the Market Capitalization for Free Float</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-total-market-capitalization-of-the-index">3. Calculate the Total Market Capitalization of the Index</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-divisor">4. Calculate the Divisor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-index-level">5. Calculate the Index Level</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#approximating-the-s-p-500-index-with-data-from-crsp">Approximating the S&amp;P 500 Index with data from CRSP</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-required-for-approximation">Data Required for Approximation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-constituent-data">Load the Constituent Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-crsp-stock-and-index-data">Load the CRSP Stock and Index Data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-a-simple-sum-of-market-caps">Method A: Simple Sum of Market Caps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-b-portfolio-rebalancing">Method B: Portfolio Rebalancing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-the-approximations">Comparing the Approximations</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jeremy Bejarano
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>