
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Cleaning TRACE Corporate Bond Data: A Walkthrough &#8212; Full Stack Quantitative Finance</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=f23691d7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=8dbc1659"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/_02_trace_cleaning_walkthrough_ipynb';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="WARNING: Notes subject to change after this week" href="../subject_to_change_after_this_week.html" />
    <link rel="prev" title="Data Sources Overview" href="_01_data_sources_overview_ipynb.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>   
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Full Stack Quantitative Finance - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Full Stack Quantitative Finance - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Full Stack Quantitative Finance
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Course Syllabus: FINM 32900, Winter 2026</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgments.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix.html">Appendix</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures üìñ</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview_w1.html">Week 1: GitHub, GitHub Classroom, and Virtual Environments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week1/what_is_this_course_about.html">What is Full Stack Quantitative Finance? Why This Course?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week1/reproducible_analytical_pipelines.html">What are Reproducible Analytical Pipelines?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week1/case_study_reproducibility_in_finance.html">Case Study: Is There A Reproducibility Crisis In Finance?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week1/virtual_environments.html">Virtual Environments</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview_w2.html">Week 2: Env Files and Secrets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week2/WRDS_intro_and_web_queries.html">Introduction to WRDS</a></li>
<li class="toctree-l2"><a class="reference internal" href="_01_wrds_python_package_ipynb.html">Example: Connecting to the WRDS Platform With Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="_05_basics_of_SQL_ipynb.html">Basics of SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week2/env_files.html">Env Files, Secrets, and the Separations of Settings from Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week2/github_pages_preview.html">GitHub Pages and Tearsheets</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview_w3.html">Week 3: Task Runners, Automating Queries, and the Basics of SQL</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week3/what_is_a_task_runner.html">What is a build system or task runner?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week3/doit_examples.html">PyDoit Examples Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week3/project_structure.html">Project Structure: ‚ÄúChartbook‚Äù Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week3/ftsfr.html">Financial Time Series Forecasting Repository (FTSFR)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview_w4.html">Week 4: Generating Reports, featuring Jupyter Notebooks and LaTeX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week4/reports_with_jupyter_notebooks.html">Reports with Jupyter Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week4/intro_to_LaTeX.html">Introduction to LaTeX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week4/latex_essentials.html">LaTeX Essentials</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview_w5.html">Week 5: Bloomberg, LSEG Datastream, and Databento</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week7/bloomberg_terminal.html">The Bloomberg Terminal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week7/LSEG_datastream.html">LSEG Datastream</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week7/databento.html">Databento</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview_w6.html">Week 6: Python Package Development and Social Coding with GitHub</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week6/GitHub_pull_requests.html">GitHub Issues and Pull Requests: Enhancing Collaborative Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week6/python_packaging_with_hatch.html">Writing and Publishing Your Own Python Packages</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview_w7.html">Week 7: Unit Tests and Documentation with Sphinx</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week5/sphinx.html">Sphinx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week5/unit_tests.html">Unit Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="_01_corporate_hedging_ipynb.html">Case Study: Hedging Oil Price Exposure As An E&amp;P</a></li>
<li class="toctree-l2"><a class="reference internal" href="_02_spx_hedging_ipynb.html">Case Study: Hedging A Long-Only SPX Portfolio With Costless Collars</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../overview_w8.html">Week 8: Medium-Sized Data and Remote Machines</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Week8/medium_sized_data_strategies.html">Strategies for Medium-Sized Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week8/polars_exercises.html">Polars Exercises: Code Snippets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week8/remote_machines_and_hpc.html">Remote Machines and High-Performance Computing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week8/exercise_jupyter_on_midway.html">Exercise: Jupyter Notebook on Midway via SSH</a></li>
<li class="toctree-l2"><a class="reference internal" href="_01_data_sources_overview_ipynb.html">Data Sources Overview</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Cleaning TRACE Corporate Bond Data: A Walkthrough</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../subject_to_change_after_this_week.html">WARNING: Notes subject to change after this week</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../overview_w9.html">Week 9: Web Authentication, GitHub Actions, and Publishing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Week8/web_authentication.html">Web Authentication and Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week9/github_actions_interactive_dashboard.html">Creating a Live Dashboard Example with GitHub Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week4/intro_to_LaTeX.html">Introduction to LaTeX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Week4/latex_essentials.html">LaTeX Essentials</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Homework üìù</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../HW0.html">Homework 0</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../HW1.html">Homework 1</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="_02_CRSP_market_index_ipynb.html">HW Guide Part A: CRSP Market Returns Indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="_03_SP500_constituents_and_index_ipynb.html">HW Guide Part B: Reconstructing the S&amp;P 500 Index</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../HW2.html">Homework 2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="_04_Fama_French_1993_ipynb.html">HW Guide Part A: Replicate Fama-French 1993</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../HW3.html">Homework 3</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../HW4.html">Homework 4</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="_01_CRSP_treasury_overview_ipynb.html">CRSP Treasury Data Oveview</a></li>
<li class="toctree-l2"><a class="reference internal" href="_02_replicate_GSW2005_ipynb.html">Replicating the G√ºrkaynak, Sack, and Wright (2006) Treasury Yield Curve</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../HW5.html">Homework 5</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../final_project.html">Final Project</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../FinalProject/final_project_rubric.html">Final Project Instructions and Rubric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FinalProject/potential_final_projects.html">List of Potential Final Projects</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jmbejara/blank_project" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jmbejara/blank_project/issues/new?title=Issue%20on%20page%20%2Fnotebooks/_02_trace_cleaning_walkthrough_ipynb.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/_02_trace_cleaning_walkthrough_ipynb.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Cleaning TRACE Corporate Bond Data: A Walkthrough</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-trace-and-why-does-cleaning-matter">1. What Is TRACE and Why Does Cleaning Matter?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-securities-does-trace-cover">What securities does TRACE cover?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-information-is-in-the-public-data">What information is in the public data?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-access">Data access</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-this-pipeline-exists-lessons-from-the-literature">Why this pipeline exists: lessons from the literature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pipeline-overview">Pipeline overview</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-sources-and-pipeline-overview">2. Data Sources and Pipeline Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#three-trace-feeds">Three TRACE feeds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fisd-reference-data-6-files">FISD reference data (6 files)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#liu-wu-treasury-yields">Liu-Wu Treasury yields</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fama-french-sic-codes">Fama-French SIC codes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#open-source-bond-asset-pricing-osbap-datasets">Open Source Bond Asset Pricing (OSBAP) datasets</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-trace-enhanced-data">3. Raw TRACE Enhanced Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-rows">Example rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trace-status-code-distribution">TRACE status code distribution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-price-distribution">Raw price distribution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-single-bonds-intraday-trades">A single bond‚Äôs intraday trades</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fisd-universe-filtering">4. FISD Universe Filtering</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-bonds-from-the-fisd-universe">Example bonds from the FISD universe</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-vs-fisd-filtered-comparison">Raw vs FISD-filtered comparison</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-0-dick-nielsen-cleaning-pipeline">5. Stage 0: Dick-Nielsen Cleaning Pipeline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-0-output-the-daily-panel">Stage 0 output: the daily panel</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Example rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-reduction-through-the-pipeline">Data reduction through the pipeline</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#daily-trade-counts-raw-vs-cleaned">Daily trade counts: raw vs cleaned</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#price-distributions-raw-vs-cleaned">Price distributions: raw vs cleaned</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#equal-weighted-vs-volume-weighted-prices">Equal-weighted vs volume-weighted prices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#market-microstructure-noise-in-context">Market microstructure noise in context</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-1-enrichment">6. Stage 1: Enrichment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Example rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#credit-spread-distribution">Credit spread distribution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modified-duration-by-credit-rating">Modified duration by credit rating</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bond-age-vs-time-to-maturity">Bond age vs time-to-maturity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#takeaways-and-best-practices">7. Takeaways and Best Practices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section class="tex2jax_ignore mathjax_ignore" id="cleaning-trace-corporate-bond-data-a-walkthrough">
<h1>Cleaning TRACE Corporate Bond Data: A Walkthrough<a class="headerlink" href="#cleaning-trace-corporate-bond-data-a-walkthrough" title="Link to this heading">#</a></h1>
<p>This notebook walks through an end-to-end pipeline for cleaning FINRA TRACE
corporate bond transaction data. We start from raw intraday trade reports and
progress through filtering, error correction, and daily aggregation to produce
an enriched panel with duration, convexity, and credit spreads.</p>
<p>We use a <strong>January‚ÄìFebruary 2024</strong> sample window throughout. The same
pipeline runs identically on the full 2002‚Äìpresent history.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Ensure src/ is importable regardless of where the notebook executes from.</span>
<span class="c1"># When run via dodo.py the cwd is the project root; when run from _output/</span>
<span class="c1"># we walk up to find the src/ directory.</span>
<span class="n">_cwd</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
<span class="n">_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">_cwd</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="n">_cwd</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="n">_cwd</span><span class="p">]</span>
<span class="k">for</span> <span class="n">_p</span> <span class="ow">in</span> <span class="n">_candidates</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_p</span> <span class="o">/</span> <span class="s2">&quot;settings.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">_p</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>  <span class="c1"># set project root as cwd</span>
        <span class="k">break</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">polars</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">config</span>

<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;DATA_DIR&quot;</span><span class="p">))</span>
<span class="n">PULL_DIR</span> <span class="o">=</span> <span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;pulled&quot;</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;figure.figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s2">&quot;axes.titlesize&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
    <span class="s2">&quot;axes.labelsize&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="s2">&quot;figure.dpi&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="what-is-trace-and-why-does-cleaning-matter">
<h2>1. What Is TRACE and Why Does Cleaning Matter?<a class="headerlink" href="#what-is-trace-and-why-does-cleaning-matter" title="Link to this heading">#</a></h2>
<p><strong>TRACE</strong> (Trade Reporting and Compliance Engine) is operated by FINRA. Every
over-the-counter (OTC) corporate bond trade in the United States must be
reported to TRACE within 15 minutes of execution. TRACE Enhanced, available
from July 2002, provides the most complete data: counterparty identifiers,
the full trade lifecycle (original reports, corrections, cancellations,
reversals), and both price and volume.</p>
<section id="what-securities-does-trace-cover">
<h3>What securities does TRACE cover?<a class="headerlink" href="#what-securities-does-trace-cover" title="Link to this heading">#</a></h3>
<p>While this project focuses on corporate bonds, TRACE covers several
categories of fixed-income securities:</p>
<ul class="simple">
<li><p><strong>Corporate bonds</strong> (investment-grade, high-yield, and convertible
debt)‚Äîreported since TRACE launched in <strong>July 2002</strong>. This is the
asset class we work with here.</p></li>
<li><p><strong>Agency debentures</strong>‚Äîreported since <strong>March 2010</strong>.</p></li>
<li><p><strong>Mortgage-backed securities (MBS) and asset-backed securities (ABS)</strong>,
including TBA transactions‚Äîreported since <strong>May 2011</strong>; public
dissemination was phased in through 2015.</p></li>
<li><p><strong>U.S. Treasury securities</strong>‚Äîreported since <strong>July 2017</strong>, but
transaction-level public dissemination only began in March 2024,
limited to on-the-run nominal coupons on an end-of-day basis. Full
Treasury transaction data is not available to the public or
researchers.</p></li>
<li><p><strong>Rule 144A private placements</strong>‚Äîreported separately; included in
our pipeline via the TRACE 144A feed.</p></li>
</ul>
</section>
<section id="what-information-is-in-the-public-data">
<h3>What information is in the public data?<a class="headerlink" href="#what-information-is-in-the-public-data" title="Link to this heading">#</a></h3>
<p>The corporate bond transaction data that FINRA makes available to the
public and to academics includes trade-level details (price, yield,
volume, execution time, buy/sell indicator, counterparty type), but
<strong>dealer identity is either removed or masked</strong>. The TRACE Enhanced
data available on WRDS does not contain unmasked dealer identifiers.</p>
</section>
<section id="data-access">
<h3>Data access<a class="headerlink" href="#data-access" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>WRDS</strong> is the most common academic access point for corporate bond
TRACE data (Enhanced, Standard, and 144A feeds). WRDS does not host
agency, MBS/ABS, or Treasury TRACE data.</p></li>
<li><p><strong>FINRA</strong> also makes corporate bond TRACE data available directly to
academic institutions and to the public (with delays). MBS/ABS
historical data requires a separate agreement with FINRA. Free
next-day transaction data and aggregate reports are available on
<a class="reference external" href="https://www.finra.org/finra-data/fixed-income">FINRA‚Äôs website</a>
for non-commercial use.</p></li>
</ul>
<p>Unlike equities, which trade on centralized exchanges with a consolidated
limit order book, corporate bonds trade OTC through dealer intermediaries.
This creates fundamental data-quality challenges:</p>
<ul class="simple">
<li><p><strong>No consolidated best bid/offer.</strong> Prices reflect individually negotiated
trades between dealers and customers or between dealers.</p></li>
<li><p><strong>Market microstructure noise (MMN)</strong> is substantially larger than in
equities. Transaction prices contain bid-ask bounce and dealer markups.</p></li>
<li><p><strong>Trade lifecycle records.</strong> A single economic trade can generate multiple
TRACE records (original report, cancellation, correction, reversal).</p></li>
</ul>
<p>Using uncleaned TRACE data leads to <strong>biased return estimates</strong> and
<strong>spurious factor premia</strong>‚Äîa problem documented extensively in recent
research.</p>
</section>
<section id="why-this-pipeline-exists-lessons-from-the-literature">
<h3>Why this pipeline exists: lessons from the literature<a class="headerlink" href="#why-this-pipeline-exists-lessons-from-the-literature" title="Link to this heading">#</a></h3>
<p><strong>Dickerson, Robotti, and Rossetti (2024), ‚ÄúCommon pitfalls in the evaluation
of corporate bond strategies‚Äù</strong> (SSRN 4575879):</p>
<ul class="simple">
<li><p>Large abnormal returns documented for many corporate bond strategies are
primarily artifacts of (a) ignoring market microstructure noise in
transaction-based prices and (b) applying ex-post (asymmetric) data
filtering.</p></li>
<li><p><strong>MMN magnitude:</strong> The short-term reversal premium drops from <strong>0.90% per
month to approximately zero</strong> after correcting for MMN. Price-based signals
(credit spread, yield) show <strong>50‚Äì65% reductions</strong> in return premiums.</p></li>
<li><p><strong>Ex-post filtering bias:</strong> Out of 480 ex-ante filtered strategies, only
2 (0.4%) produce significant momentum premia. With ex-post filtering, that
number jumps to 119 (25%)‚Äîalmost entirely an artifact.</p></li>
<li><p><strong>Recommendation:</strong> Use an ‚Äúimplementation gap‚Äù (source signal prices at
least one day before month-end execution prices) and apply only ex-ante
filters with information available at portfolio formation.</p></li>
</ul>
<p><strong>Dickerson, Robotti, and Rossetti (2026), ‚ÄúThe Corporate Bond Factor
Replication Crisis‚Äù:</strong></p>
<ul class="simple">
<li><p>Evaluates <strong>108 signals across 9 thematic clusters</strong> using the Open Bond
Asset Pricing (OBAP) framework.</p></li>
<li><p>Two sources systematically inflate reported premia: (a) OTC
microstructure that prevents execution at signal-formation prices, and
(b) ex-post filtering that embeds future information into portfolio
construction.</p></li>
<li><p><strong>Result:</strong> The majority of previously documented anomalies fail‚Äîthey
are artifacts of measurement error, not genuine risk premia.</p></li>
<li><p>Provides an <strong>open-source end-to-end TRACE data pipeline</strong> (the basis
for the Stage 0 cleaning code in this project).</p></li>
</ul>
</section>
<section id="pipeline-overview">
<h3>Pipeline overview<a class="headerlink" href="#pipeline-overview" title="Link to this heading">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Raw</span> <span class="n">TRACE</span> <span class="n">Enhanced</span>   <span class="o">--</span><span class="p">[</span><span class="n">FISD</span> <span class="nb">filter</span><span class="p">]</span><span class="o">--&gt;</span>   <span class="n">FISD</span><span class="o">-</span><span class="n">filtered</span>   <span class="o">--</span><span class="p">[</span><span class="mi">11</span> <span class="n">filters</span> <span class="o">+</span> <span class="n">daily</span> <span class="n">agg</span><span class="p">]</span><span class="o">--&gt;</span>   <span class="n">Stage</span> <span class="mi">0</span>
  <span class="p">(</span><span class="n">intraday</span> <span class="n">trades</span><span class="p">)</span>                       <span class="p">(</span><span class="n">standard</span> <span class="n">US</span>                                     <span class="p">(</span><span class="n">daily</span> <span class="n">panel</span><span class="p">)</span>
                                           <span class="n">corporate</span> <span class="n">bonds</span><span class="p">)</span>                                    <span class="o">|</span>
                                                                                               <span class="n">v</span>
                                                             <span class="n">Stage</span> <span class="mi">1</span>  <span class="o">&lt;--</span><span class="p">[</span><span class="n">QuantLib</span> <span class="o">+</span> <span class="n">ratings</span> <span class="o">+</span> <span class="n">linker</span><span class="p">]</span>
                                                        <span class="p">(</span><span class="n">enriched</span> <span class="n">panel</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span> <span class="n">convexity</span><span class="p">,</span>
                                                         <span class="n">credit</span> <span class="n">spreads</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">equity</span> <span class="n">IDs</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="data-sources-and-pipeline-overview">
<h2>2. Data Sources and Pipeline Overview<a class="headerlink" href="#data-sources-and-pipeline-overview" title="Link to this heading">#</a></h2>
<p>The pipeline consumes <strong>14 datasets</strong> from four providers: WRDS (TRACE
trade feeds and FISD bond reference tables), the Liu-Wu yield curve
(Google Sheets), the Kenneth French Data Library (Dartmouth), and the
Open Source Bond Asset Pricing project
(<a class="reference external" href="https://openbondassetpricing.com">openbondassetpricing.com</a>). These
fall into three groups: <strong>trade data</strong> (the raw transactions we clean),
<strong>bond reference data</strong> (characteristics, ratings, and identifiers we
merge in), and <strong>validation / linkage data</strong> (external benchmarks and
cross-asset links).</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>#</p></th>
<th class="head"><p>Dataset</p></th>
<th class="head"><p>Source</p></th>
<th class="head"><p>Pipeline role</p></th>
<th class="head"><p>Stage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>TRACE Enhanced</p></td>
<td><p>WRDS</p></td>
<td><p>Primary trade data (Jul 2002‚ÄìSep 2024)</p></td>
<td><p>Pull <span class="math notranslate nohighlight">\(\to\)</span> FISD filter <span class="math notranslate nohighlight">\(\to\)</span> Stage 0 <span class="math notranslate nohighlight">\(\to\)</span> Stage 1</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>TRACE Standard</p></td>
<td><p>WRDS</p></td>
<td><p>Extends trade coverage (Oct 2024+)</p></td>
<td><p>Pull <span class="math notranslate nohighlight">\(\to\)</span> FISD filter <span class="math notranslate nohighlight">\(\to\)</span> Stage 0 <span class="math notranslate nohighlight">\(\to\)</span> Stage 1</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>TRACE 144A</p></td>
<td><p>WRDS</p></td>
<td><p>Private-placement trades (Rule 144A)</p></td>
<td><p>Pull <span class="math notranslate nohighlight">\(\to\)</span> FISD filter <span class="math notranslate nohighlight">\(\to\)</span> Stage 0 <span class="math notranslate nohighlight">\(\to\)</span> Stage 1</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>FISD Issue</p></td>
<td><p>WRDS</p></td>
<td><p>Bond-level reference (coupon, maturity, offering)</p></td>
<td><p>Pre-processing + Stage 1</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>FISD Issuer</p></td>
<td><p>WRDS</p></td>
<td><p>Issuer attributes (SIC code, country)</p></td>
<td><p>Pre-processing</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>FISD Amount Outstanding</p></td>
<td><p>WRDS</p></td>
<td><p>Time-varying par amount outstanding</p></td>
<td><p>Stage 1</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>FISD Ratings (S&amp;P)</p></td>
<td><p>WRDS</p></td>
<td><p>Historical S&amp;P credit ratings</p></td>
<td><p>Stage 1</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>FISD Ratings (Moody‚Äôs)</p></td>
<td><p>WRDS</p></td>
<td><p>Historical Moody‚Äôs credit ratings</p></td>
<td><p>Stage 1</p></td>
</tr>
<tr class="row-even"><td><p>9</p></td>
<td><p>FISD Redemption</p></td>
<td><p>WRDS</p></td>
<td><p>Callable-bond flag</p></td>
<td><p>Stage 1</p></td>
</tr>
<tr class="row-odd"><td><p>10</p></td>
<td><p>Liu-Wu Treasury Yields</p></td>
<td><p>Google Sheets</p></td>
<td><p>Zero-coupon yield curve for credit spreads</p></td>
<td><p>Stage 1</p></td>
</tr>
<tr class="row-even"><td><p>11</p></td>
<td><p>Fama-French SIC Codes</p></td>
<td><p>Dartmouth</p></td>
<td><p>Industry classification (FF-17 / FF-30)</p></td>
<td><p>Stage 1</p></td>
</tr>
<tr class="row-odd"><td><p>12</p></td>
<td><p>OSBAP Linker (Fang, 2025)</p></td>
<td><p>OSBAP</p></td>
<td><p>Bond-to-equity identifier mapping</p></td>
<td><p>Stage 1</p></td>
</tr>
<tr class="row-even"><td><p>13</p></td>
<td><p>OSBAP Corporate Bond Returns</p></td>
<td><p>OSBAP</p></td>
<td><p>Validation benchmark (duration, spreads)</p></td>
<td><p>Testing only</p></td>
</tr>
<tr class="row-odd"><td><p>14</p></td>
<td><p>OSBAP Treasury Bond Returns</p></td>
<td><p>OSBAP</p></td>
<td><p>Not currently consumed</p></td>
<td><p>‚Äî</p></td>
</tr>
</tbody>
</table>
</div>
<section id="three-trace-feeds">
<h3>Three TRACE feeds<a class="headerlink" href="#three-trace-feeds" title="Link to this heading">#</a></h3>
<p>FINRA publishes corporate bond trades through three separate reporting
channels. The pipeline pulls all three and merges them after cleaning:</p>
<ul class="simple">
<li><p><strong>Enhanced</strong> is the workhorse dataset. It has the longest history
(July 2002 onward), the richest columns (exact volume in
<code class="docutils literal notranslate"><span class="pre">entrd_vol_qt</span></code>, counterparty IDs in <code class="docutils literal notranslate"><span class="pre">cntra_mp_id</span></code>), and is the
target of most academic TRACE-cleaning papers.</p></li>
<li><p><strong>Standard</strong> is the real-time public feed. WRDS makes it available
from October 2024, so it extends coverage into months where Enhanced
is not yet released. It uses a slightly different column schema
(<code class="docutils literal notranslate"><span class="pre">ascii_rptd_vol_tx</span></code> for volume, <code class="docutils literal notranslate"><span class="pre">side</span></code> instead of <code class="docutils literal notranslate"><span class="pre">rpt_side_cd</span></code>).</p></li>
<li><p><strong>144A</strong> captures a separate market segment: bonds sold to qualified
institutional buyers under SEC Rule 144A. These private placements
do not appear in the Enhanced or Standard feeds.</p></li>
</ul>
<p>When the three are combined in Stage 1, <strong>Enhanced takes priority</strong>.
Standard is clipped to dates <em>after</em> the Enhanced maximum date to
avoid overlap, while 144A rows are kept unconditionally (they cover
distinct bonds). Duplicate (cusip, date) pairs across feeds are
resolved with preference Enhanced &gt; Standard &gt; 144A.</p>
</section>
<section id="fisd-reference-data-6-files">
<h3>FISD reference data (6 files)<a class="headerlink" href="#fisd-reference-data-6-files" title="Link to this heading">#</a></h3>
<p>The Mergent Fixed Income Securities Database (FISD), accessed via WRDS,
provides the bond-level reference data that the pipeline relies on
throughout:</p>
<ul class="simple">
<li><p><strong>FISD Issue</strong> ‚Äî One row per bond. Coupon, maturity, offering date,
offering amount, bond type, currency, and other characteristics.
Combined with FISD Issuer to build the <strong>FISD universe</strong> of standard
US corporate bonds (10 screens: USD only, fixed-rate, non-convertible,
non-ABS, etc.). Also used in Stage 1 to map <code class="docutils literal notranslate"><span class="pre">issue_id</span></code> to CUSIP for
ratings and amount-outstanding merges.</p></li>
<li><p><strong>FISD Issuer</strong> ‚Äî One row per issuer. Provides the SIC code (used
for Fama-French industry classification) and country of domicile.</p></li>
<li><p><strong>FISD Amount Outstanding History</strong> ‚Äî Time-varying par amount.
Merged into the Stage 1 panel via <code class="docutils literal notranslate"><span class="pre">merge_asof</span></code> (backward on date) so
each bond-day observation reflects the most recent outstanding amount.</p></li>
<li><p><strong>FISD Ratings (S&amp;P)</strong> and <strong>FISD Ratings (Moody‚Äôs)</strong> ‚Äî Historical
credit ratings (one row per rating event). Converted to numeric
scales in Stage 1 and merged via <code class="docutils literal notranslate"><span class="pre">merge_asof</span></code> so each bond-day gets
the most recent rating. A composite rating is computed as the average
of the S&amp;P and Moody‚Äôs numeric scores.</p></li>
<li><p><strong>FISD Redemption</strong> ‚Äî Callable/redeemable flags. Produces a binary
<code class="docutils literal notranslate"><span class="pre">callable</span></code> indicator merged into Stage 1.</p></li>
</ul>
</section>
<section id="liu-wu-treasury-yields">
<h3>Liu-Wu Treasury yields<a class="headerlink" href="#liu-wu-treasury-yields" title="Link to this heading">#</a></h3>
<p>The Liu-Wu zero-coupon Treasury yield curve (sourced from a Google
Sheets mirror of the original Liu-Wu dataset) provides daily yields
at 1, 2, 5, 7, 10, 20, and 30-year maturities. Stage 1 interpolates
this curve at each bond‚Äôs remaining maturity and subtracts the
duration-matched Treasury yield from the bond‚Äôs yield-to-maturity to
compute the <strong>credit spread</strong>.</p>
</section>
<section id="fama-french-sic-codes">
<h3>Fama-French SIC codes<a class="headerlink" href="#fama-french-sic-codes" title="Link to this heading">#</a></h3>
<p>The Kenneth French Data Library provides mappings from SIC code ranges
to the Fama-French 17-industry and 30-industry classification systems.
In Stage 1, each bond issuer‚Äôs SIC code (from FISD Issuer) is matched
to these ranges, adding <code class="docutils literal notranslate"><span class="pre">ff17num</span></code> and <code class="docutils literal notranslate"><span class="pre">ff30num</span></code> industry identifiers
to every bond-day observation.</p>
</section>
<section id="open-source-bond-asset-pricing-osbap-datasets">
<h3>Open Source Bond Asset Pricing (OSBAP) datasets<a class="headerlink" href="#open-source-bond-asset-pricing-osbap-datasets" title="Link to this heading">#</a></h3>
<p>The OSBAP project at
<a class="reference external" href="https://openbondassetpricing.com">openbondassetpricing.com</a> provides
three files that play different roles:</p>
<ul class="simple">
<li><p><strong>OSBAP Linker (Fang, 2025)</strong> ‚Äî A core Stage 1 input. Maps issuer
CUSIPs (first 6 characters) to equity identifiers (PERMNO, PERMCO,
GVKEY) over time. Many bonds are issued through subsidiaries that do
not share the parent‚Äôs identifiers, and 19% of CUSIP-6s change
ultimate parents during the sample. The linker resolves this using
CUSIP-ticker mappings from ICE and TRACE, the ticker-GVKEY mapping
from Compustat, and the CRSP-Compustat link, with extensive hand
corrections. Forward-filled and left-joined on (issuer CUSIP,
year-month) in Stage 1 Step 7.</p></li>
<li><p><strong>OSBAP Corporate Bond Returns</strong> ‚Äî A <strong>validation-only</strong> benchmark.
The test suite (<code class="docutils literal notranslate"><span class="pre">test_stage1_vs_open_source.py</span></code>) aggregates Stage 1
daily output to month-end, inner-joins with OSBAP on (cusip, date),
and checks that yield-to-maturity, modified duration, convexity,
credit spread, time-to-maturity, bond market cap, bond age, and
industry classifications are highly correlated and within acceptable
tolerance. This is how we confirm the pipeline is producing
correct results.</p></li>
<li><p><strong>OSBAP Treasury Bond Returns</strong> ‚Äî Pulled for completeness but not
currently consumed by any processing or validation stage.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="raw-trace-enhanced-data">
<h2>3. Raw TRACE Enhanced Data<a class="headerlink" href="#raw-trace-enhanced-data" title="Link to this heading">#</a></h2>
<p>Each row in raw TRACE is a <strong>single trade report</strong>. Key columns:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Column</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cusip_id</span></code></p></td>
<td><p>9-character bond identifier</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">trd_exctn_dt</span></code> / <code class="docutils literal notranslate"><span class="pre">trd_exctn_tm</span></code></p></td>
<td><p>Execution date and time</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rptd_pr</span></code></p></td>
<td><p>Reported price per $100 par</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">entrd_vol_qt</span></code></p></td>
<td><p>Par volume traded</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">yld_pt</span></code></p></td>
<td><p>Yield at time of trade</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">trc_st</span></code></p></td>
<td><p>Status code: <strong>T</strong> = original trade, <strong>X</strong> = cancellation, <strong>C</strong> = correction, <strong>W</strong>/<strong>Y</strong> = reversal</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rpt_side_cd</span></code></p></td>
<td><p><strong>B</strong> = buy, <strong>S</strong> = sell (from reporting dealer perspective)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">cntra_mp_id</span></code></p></td>
<td><p>Counterparty: <strong>C</strong> = customer, <strong>D</strong> = inter-dealer</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">msg_seq_nb</span></code> / <code class="docutils literal notranslate"><span class="pre">orig_msg_seq_nb</span></code></p></td>
<td><p>Sequence numbers for matching corrections to originals</p></td>
</tr>
</tbody>
</table>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raw</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span>
    <span class="n">PULL_DIR</span> <span class="o">/</span> <span class="s2">&quot;trace_enhanced&quot;</span> <span class="o">/</span> <span class="s2">&quot;**/*.parquet&quot;</span><span class="p">,</span>
    <span class="n">hive_partitioning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">missing_columns</span><span class="o">=</span><span class="s2">&quot;insert&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2024</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">n_raw</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">cols_raw</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw TRACE Enhanced (Jan 2024) -- Rows: </span><span class="si">{</span><span class="n">n_raw</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">  |  Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cols_raw</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raw TRACE Enhanced (Jan 2024) -- Rows: 3,768,457  |  Columns: 21
</pre></div>
</div>
</div>
</div>
<section id="example-rows">
<h3>Example rows<a class="headerlink" href="#example-rows" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raw</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 21)</small><table border="1" class="dataframe"><thead><tr><th>cusip_id</th><th>bond_sym_id</th><th>trd_exctn_dt</th><th>trd_exctn_tm</th><th>days_to_sttl_ct</th><th>lckd_in_ind</th><th>wis_fl</th><th>sale_cndtn_cd</th><th>msg_seq_nb</th><th>trc_st</th><th>trd_rpt_dt</th><th>trd_rpt_tm</th><th>entrd_vol_qt</th><th>rptd_pr</th><th>yld_pt</th><th>asof_cd</th><th>orig_msg_seq_nb</th><th>rpt_side_cd</th><th>cntra_mp_id</th><th>year</th><th>month</th></tr><tr><td>str</td><td>str</td><td>date</td><td>i64</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>date</td><td>i64</td><td>f64</td><td>f64</td><td>f64</td><td>str</td><td>str</td><td>str</td><td>str</td><td>i64</td><td>i64</td></tr></thead><tbody><tr><td>&quot;02209SBD4&quot;</td><td>&quot;MO4797929&quot;</td><td>2024-01-01</td><td>78261000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000453&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28812000000000</td><td>3000.0</td><td>100.049</td><td>4.787982</td><td>&quot;A&quot;</td><td>null</td><td>&quot;B&quot;</td><td>&quot;D&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;02209SBD4&quot;</td><td>&quot;MO4797929&quot;</td><td>2024-01-01</td><td>78261000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000555&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28813000000000</td><td>3000.0</td><td>100.049</td><td>4.787982</td><td>&quot;A&quot;</td><td>null</td><td>&quot;S&quot;</td><td>&quot;D&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;254687FS0&quot;</td><td>&quot;DIS4969022&quot;</td><td>2024-01-01</td><td>81521000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000479&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28812000000000</td><td>5000.0</td><td>97.448</td><td>4.872966</td><td>&quot;A&quot;</td><td>null</td><td>&quot;B&quot;</td><td>&quot;D&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;254687FS0&quot;</td><td>&quot;DIS4969022&quot;</td><td>2024-01-01</td><td>81521000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000547&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28813000000000</td><td>5000.0</td><td>97.448</td><td>4.872966</td><td>&quot;A&quot;</td><td>null</td><td>&quot;S&quot;</td><td>&quot;D&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;30303M8J4&quot;</td><td>&quot;FB5522214&quot;</td><td>2024-01-01</td><td>81331000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000474&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28812000000000</td><td>10000.0</td><td>92.531</td><td>4.940009</td><td>&quot;A&quot;</td><td>null</td><td>&quot;B&quot;</td><td>&quot;D&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;30303M8J4&quot;</td><td>&quot;FB5522214&quot;</td><td>2024-01-01</td><td>81331000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000558&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28813000000000</td><td>10000.0</td><td>92.531</td><td>4.940009</td><td>&quot;A&quot;</td><td>null</td><td>&quot;S&quot;</td><td>&quot;D&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;404280DH9&quot;</td><td>&quot;HBC5458071&quot;</td><td>2024-01-01</td><td>81225000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000072&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28807000000000</td><td>2e6</td><td>101.0</td><td>null</td><td>&quot;A&quot;</td><td>null</td><td>&quot;S&quot;</td><td>&quot;A&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;458140BX7&quot;</td><td>&quot;INTC5238071&quot;</td><td>2024-01-01</td><td>81367000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000477&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28812000000000</td><td>10000.0</td><td>69.707</td><td>4.993</td><td>&quot;A&quot;</td><td>null</td><td>&quot;B&quot;</td><td>&quot;D&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;458140BX7&quot;</td><td>&quot;INTC5238071&quot;</td><td>2024-01-01</td><td>81367000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000566&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28813000000000</td><td>10000.0</td><td>69.707</td><td>4.993</td><td>&quot;A&quot;</td><td>null</td><td>&quot;S&quot;</td><td>&quot;D&quot;</td><td>2024</td><td>1</td></tr><tr><td>&quot;46647PCQ7&quot;</td><td>&quot;JPM5260072&quot;</td><td>2024-01-01</td><td>76026000000000</td><td>null</td><td>null</td><td>&quot;N&quot;</td><td>null</td><td>&quot;0000676&quot;</td><td>&quot;T&quot;</td><td>2024-01-02</td><td>28814000000000</td><td>3e6</td><td>98.89</td><td>null</td><td>&quot;A&quot;</td><td>null</td><td>&quot;B&quot;</td><td>&quot;A&quot;</td><td>2024</td><td>1</td></tr></tbody></table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raw</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">glimpse</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rows: 10
Columns: 21
$ cusip_id         &lt;str&gt; &#39;Y8085FBU3&#39;, &#39;Y8085FBU3&#39;, &#39;Y8085FBU3&#39;, &#39;Y8846QAG1&#39;, &#39;Y8846QAG1&#39;, &#39;Y8846QAG1&#39;, &#39;Y8846QAG1&#39;, &#39;Y8850AAB0&#39;, &#39;Y93541AA1&#39;, &#39;Y93541AA1&#39;
$ bond_sym_id      &lt;str&gt; &#39;HXSCF5730863&#39;, &#39;HXSCF5730863&#39;, &#39;HXSCF5730863&#39;, &#39;PTFRF4937561&#39;, &#39;PTFRF4937561&#39;, &#39;PTFRF4937561&#39;, &#39;PTFRF4937561&#39;, &#39;TNABY4760205&#39;, &#39;CHVKF4590832&#39;, &#39;CHVKF4590832&#39;
$ trd_exctn_dt    &lt;date&gt; 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31
$ trd_exctn_tm     &lt;i64&gt; 36763000000000, 36763000000000, 42120000000000, 6279000000000, 6279000000000, 8933000000000, 30235000000000, 42808000000000, 16600000000000, 16600000000000
$ days_to_sttl_ct  &lt;str&gt; null, null, null, null, null, null, null, null, null, null
$ lckd_in_ind      &lt;str&gt; null, null, null, null, null, null, null, null, null, null
$ wis_fl           &lt;str&gt; &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;
$ sale_cndtn_cd    &lt;str&gt; null, null, null, null, null, null, null, null, null, null
$ msg_seq_nb       &lt;str&gt; &#39;0040572&#39;, &#39;0040573&#39;, &#39;0087790&#39;, &#39;0001307&#39;, &#39;0001333&#39;, &#39;0002973&#39;, &#39;0007559&#39;, &#39;0093183&#39;, &#39;0004037&#39;, &#39;0004038&#39;
$ trc_st           &lt;str&gt; &#39;T&#39;, &#39;T&#39;, &#39;T&#39;, &#39;T&#39;, &#39;T&#39;, &#39;T&#39;, &#39;T&#39;, &#39;T&#39;, &#39;T&#39;, &#39;T&#39;
$ trd_rpt_dt      &lt;date&gt; 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31, 2024-01-31
$ trd_rpt_tm       &lt;i64&gt; 36766000000000, 36766000000000, 42245000000000, 28817000000000, 28817000000000, 28855000000000, 30236000000000, 42838000000000, 28890000000000, 28890000000000
$ entrd_vol_qt     &lt;f64&gt; 200000.0, 200000.0, 400000.0, 1600000.0, 1600000.0, 200000.0, 1000000.0, 210000.0, 1000000.0, 1000000.0
$ rptd_pr          &lt;f64&gt; 101.11, 101.11, 101.153, 98.625, 98.625, 98.63, 98.55, 99.911, 63.875, 63.875
$ yld_pt           &lt;f64&gt; null, null, null, null, null, null, null, null, null, null
$ asof_cd          &lt;str&gt; null, null, null, null, null, null, null, null, null, null
$ orig_msg_seq_nb  &lt;str&gt; null, null, null, null, null, null, null, null, null, null
$ rpt_side_cd      &lt;str&gt; &#39;S&#39;, &#39;B&#39;, &#39;S&#39;, &#39;S&#39;, &#39;B&#39;, &#39;B&#39;, &#39;B&#39;, &#39;B&#39;, &#39;S&#39;, &#39;B&#39;
$ cntra_mp_id      &lt;str&gt; &#39;C&#39;, &#39;A&#39;, &#39;C&#39;, &#39;A&#39;, &#39;C&#39;, &#39;C&#39;, &#39;C&#39;, &#39;C&#39;, &#39;C&#39;, &#39;A&#39;
$ year             &lt;i64&gt; 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024
$ month            &lt;i64&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
</pre></div>
</div>
</div>
</div>
</section>
<section id="trace-status-code-distribution">
<h3>TRACE status code distribution<a class="headerlink" href="#trace-status-code-distribution" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">trc_st</span></code> column tells us whether a record is an original trade (<strong>T</strong>),
a cancellation (<strong>X</strong>), a correction (<strong>C</strong>), or a reversal (<strong>W</strong>/<strong>Y</strong>).
Only status-T records represent actual trades. The rest are amendments to
prior records and must be matched and handled by the Dick-Nielsen cleaning
procedure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">trc_st_dist</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;trc_st&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">trc_st_dist</span><span class="p">[</span><span class="s2">&quot;trc_st&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="n">trc_st_dist</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">trc_st_dist</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of records&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;trc_st code&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;TRACE Enhanced (Jan 2024) -- Record type distribution&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3d938e17e6e4f0cbd93b80b0f238e3e67d6821ab462d65d07766b8e9e7419c64.png" src="../_images/3d938e17e6e4f0cbd93b80b0f238e3e67d6821ab462d65d07766b8e9e7419c64.png" />
</div>
</div>
<p>The large number of <strong>C</strong> (correction) and <strong>X</strong> (cancellation) records is
exactly why the Dick-Nielsen cleaning procedure exists. These are not
separate trades‚Äîthey are amendments to prior trade reports.</p>
</section>
<section id="raw-price-distribution">
<h3>Raw price distribution<a class="headerlink" href="#raw-price-distribution" title="Link to this heading">#</a></h3>
<p>Raw data contains extreme prices from decimal-shift errors, data entry
mistakes, and pre-cancellation records. The log-scale histogram reveals
a long tail, while the right panel shows the ‚Äútrue‚Äù distribution concentrated
near par (~100).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raw_prices</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;rptd_pr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="s2">&quot;rptd_pr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">raw_prices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">raw_prices</span><span class="p">)],</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Reported price ($)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raw prices -- full range (log scale)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_prices</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_prices</span> <span class="o">&lt;=</span> <span class="mi">250</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">raw_prices</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Reported price ($)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raw prices -- 0 &lt; price &lt;= $250&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prices &lt;= 0:   </span><span class="si">{</span><span class="p">(</span><span class="n">raw_prices</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prices &gt; 1000: </span><span class="si">{</span><span class="p">(</span><span class="n">raw_prices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">raw_prices</span><span class="p">)]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Null prices:   </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">raw_prices</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d2be7e7041b2dcbede696a685c8b4c64cb80990e204108213af3ca06abd02745.png" src="../_images/d2be7e7041b2dcbede696a685c8b4c64cb80990e204108213af3ca06abd02745.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Prices &lt;= 0:   0
Prices &gt; 1000: 29
Null prices:   0
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-single-bonds-intraday-trades">
<h3>A single bond‚Äôs intraday trades<a class="headerlink" href="#a-single-bonds-intraday-trades" title="Link to this heading">#</a></h3>
<p>To build intuition, let‚Äôs look at a single well-traded bond across one day.
We plot every TRACE record colored by its status code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_cusips</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trc_st&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 5 CUSIPs by original-trade count (Jan 2024):&quot;</span><span class="p">)</span>
<span class="n">top_cusips</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top 5 CUSIPs by original-trade count (Jan 2024):
</pre></div>
</div>
<div class="output text_html"><div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (5, 2)</small><table border="1" class="dataframe"><thead><tr><th>cusip_id</th><th>n</th></tr><tr><td>str</td><td>u32</td></tr></thead><tbody><tr><td>&quot;95000U3B7&quot;</td><td>16722</td></tr><tr><td>&quot;126650CX6&quot;</td><td>5750</td></tr><tr><td>&quot;06051GFM6&quot;</td><td>5477</td></tr><tr><td>&quot;718172CW7&quot;</td><td>4992</td></tr><tr><td>&quot;20030NCT6&quot;</td><td>4384</td></tr></tbody></table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find a cusip-date pair that has multiple status codes (T, C, X, etc.)</span>
<span class="c1"># so the scatter plot illustrates the lifecycle records.</span>
<span class="n">_cusip_date_mix</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">,</span> <span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trc_st&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">n_unique</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n_status&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n_records&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;n_status&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;n_records&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Fall back to the most-traded cusip on 2024-01-16 if no multi-status pair found</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cusip_date_mix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">example_cusip</span> <span class="o">=</span> <span class="n">_cusip_date_mix</span><span class="p">[</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">example_date</span> <span class="o">=</span> <span class="n">_cusip_date_mix</span><span class="p">[</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">example_cusip</span> <span class="o">=</span> <span class="n">top_cusips</span><span class="p">[</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">example_date</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">intraday</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">example_cusip</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">example_date</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">example_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;2024-01-16&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">to_date</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;trd_exctn_tm&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># If the chosen date is empty, fall back to the first available date</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intraday</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">first_date</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">example_cusip</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">intraday</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">example_cusip</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">first_date</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;trd_exctn_tm&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="p">)</span>

<span class="c1"># Convert trd_exctn_tm to hours for plotting</span>
<span class="n">tm_col</span> <span class="o">=</span> <span class="n">intraday</span><span class="p">[</span><span class="s2">&quot;trd_exctn_tm&quot;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">tm_col</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt64</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">):</span>
    <span class="n">times_hrs</span> <span class="o">=</span> <span class="n">tm_col</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="mi">3600</span>
<span class="k">elif</span> <span class="n">tm_col</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Duration</span><span class="p">:</span>
    <span class="n">times_hrs</span> <span class="o">=</span> <span class="n">tm_col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span>
<span class="k">elif</span> <span class="n">tm_col</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Time</span><span class="p">:</span>
    <span class="n">times_hrs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">tm_col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">tm_col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">tm_col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># String HH:MM:SS</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">tm_col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">times_hrs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">parts</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="o">+</span> <span class="n">parts</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">trade_date</span> <span class="o">=</span> <span class="n">intraday</span><span class="p">[</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">intraday</span><span class="p">[</span><span class="s2">&quot;rptd_pr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">statuses</span> <span class="o">=</span> <span class="n">intraday</span><span class="p">[</span><span class="s2">&quot;trc_st&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="n">colors_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">}</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">statuses</span><span class="p">)):</span>
    <span class="n">mask_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span> <span class="o">==</span> <span class="n">status</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">statuses</span><span class="p">])</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">200</span> <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">25</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">times_hrs</span><span class="p">[</span><span class="n">mask_s</span><span class="p">],</span>
        <span class="n">prices</span><span class="p">[</span><span class="n">mask_s</span><span class="p">],</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;trc_st=</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of day&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Reported price ($)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intraday trades for </span><span class="si">{</span><span class="n">example_cusip</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">trade_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total records: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">intraday</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">statuses</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  trc_st=</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">statuses</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d990d26bbb1116822f6872dda42a78f3cacc8b7a87eeba73eb2f7dcad7c34879.png" src="../_images/d990d26bbb1116822f6872dda42a78f3cacc8b7a87eeba73eb2f7dcad7c34879.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total records: 10192
  trc_st=C: 1
  trc_st=R: 1
  trc_st=T: 5126
  trc_st=X: 5064
</pre></div>
</div>
</div>
</div>
<p>Cancellations (red) and corrections (orange) are <strong>not independent trades</strong>.
They reference prior records via <code class="docutils literal notranslate"><span class="pre">orig_msg_seq_nb</span></code> and must be matched and
removed or replaced. This is the job of the Dick-Nielsen procedure.</p>
</section>
</section>
<hr class="docutils" />
<section id="fisd-universe-filtering">
<h2>4. FISD Universe Filtering<a class="headerlink" href="#fisd-universe-filtering" title="Link to this heading">#</a></h2>
<p>Before cleaning trade data, we restrict to <strong>standard US corporate bonds</strong>
using the Mergent Fixed Income Securities Database (FISD). The universe is
built with these screens:</p>
<ol class="arabic simple">
<li><p>USD denominated only</p></li>
<li><p>Fixed-rate coupon (exclude variable)</p></li>
<li><p>Non-convertible</p></li>
<li><p>Non-asset-backed</p></li>
<li><p>Exclude government, municipal, MBS, ABS, and other non-corporate types</p></li>
<li><p>Valid coupon frequency</p></li>
<li><p>Complete accrual fields (offering_date, dated_date)</p></li>
<li><p>Principal amount = $1,000</p></li>
<li><p>Exclude equity-linked / index-linked bonds</p></li>
<li><p>Tenor &gt;= 1 year</p></li>
</ol>
<p>We then inner-join TRACE on <code class="docutils literal notranslate"><span class="pre">cusip_id</span></code> with the FISD universe, dropping all
non-matching bonds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fisd</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;fisd_universe.parquet&quot;</span><span class="p">)</span>
<span class="n">n_fisd</span> <span class="o">=</span> <span class="n">fisd</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FISD Universe: </span><span class="si">{</span><span class="n">n_fisd</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> bonds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FISD Universe: 111,727 bonds
</pre></div>
</div>
</div>
</div>
<section id="example-bonds-from-the-fisd-universe">
<h3>Example bonds from the FISD universe<a class="headerlink" href="#example-bonds-from-the-fisd-universe" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fisd</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (5, 22)</small><table border="1" class="dataframe"><thead><tr><th>complete_cusip</th><th>issue_id</th><th>issue_name</th><th>issuer_id</th><th>foreign_currency</th><th>coupon_type</th><th>coupon</th><th>convertible</th><th>asset_backed</th><th>rule_144a</th><th>bond_type</th><th>private_placement</th><th>interest_frequency</th><th>dated_date</th><th>day_count_basis</th><th>offering_date</th><th>maturity</th><th>principal_amt</th><th>offering_amt</th><th>country_domicile</th><th>sic_code</th><th>tenor</th></tr><tr><td>str</td><td>f64</td><td>str</td><td>f64</td><td>str</td><td>str</td><td>f64</td><td>str</td><td>str</td><td>str</td><td>str</td><td>str</td><td>i64</td><td>date</td><td>str</td><td>date</td><td>date</td><td>f64</td><td>f64</td><td>str</td><td>str</td><td>f64</td></tr></thead><tbody><tr><td>&quot;000361AA3&quot;</td><td>1.0</td><td>&quot;NT&quot;</td><td>3.0</td><td>&quot;N&quot;</td><td>&quot;F&quot;</td><td>9.5</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;CDEB&quot;</td><td>&quot;N&quot;</td><td>2</td><td>1989-11-01</td><td>&quot;30/360&quot;</td><td>1989-10-24</td><td>2001-11-01</td><td>1000.0</td><td>65000.0</td><td>&quot;USA&quot;</td><td>&quot;3720&quot;</td><td>12.021903</td></tr><tr><td>&quot;000361AB1&quot;</td><td>2.0</td><td>&quot;NT&quot;</td><td>3.0</td><td>&quot;N&quot;</td><td>&quot;F&quot;</td><td>7.25</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;CDEB&quot;</td><td>&quot;N&quot;</td><td>2</td><td>1993-10-15</td><td>&quot;30/360&quot;</td><td>1993-10-12</td><td>2003-10-15</td><td>1000.0</td><td>50000.0</td><td>&quot;USA&quot;</td><td>&quot;3720&quot;</td><td>10.006845</td></tr><tr><td>&quot;00077DAB5&quot;</td><td>3.0</td><td>&quot;MTN&quot;</td><td>40263.0</td><td>&quot;N&quot;</td><td>&quot;F&quot;</td><td>4.15</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;CMTN&quot;</td><td>&quot;N&quot;</td><td>2</td><td>1994-01-14</td><td>&quot;30/360&quot;</td><td>1994-01-07</td><td>1996-01-12</td><td>1000.0</td><td>100000.0</td><td>&quot;USA&quot;</td><td>&quot;6029&quot;</td><td>2.01232</td></tr><tr><td>&quot;00077DAF6&quot;</td><td>4.0</td><td>&quot;SUB DEP NT SER B&quot;</td><td>40263.0</td><td>&quot;N&quot;</td><td>&quot;F&quot;</td><td>8.25</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;USBN&quot;</td><td>&quot;N&quot;</td><td>2</td><td>1994-08-02</td><td>&quot;30/360&quot;</td><td>1994-07-27</td><td>2009-08-01</td><td>1000.0</td><td>200000.0</td><td>&quot;USA&quot;</td><td>&quot;6029&quot;</td><td>15.014374</td></tr><tr><td>&quot;00077TAA2&quot;</td><td>5.0</td><td>&quot;SUB DEP NT SER B&quot;</td><td>40263.0</td><td>&quot;N&quot;</td><td>&quot;F&quot;</td><td>7.75</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;N&quot;</td><td>&quot;CDEB&quot;</td><td>&quot;N&quot;</td><td>2</td><td>1993-05-15</td><td>&quot;30/360&quot;</td><td>1993-05-20</td><td>2023-05-15</td><td>1000.0</td><td>250000.0</td><td>&quot;USA&quot;</td><td>&quot;6029&quot;</td><td>29.984942</td></tr></tbody></table></div></div></div>
</div>
</section>
<section id="raw-vs-fisd-filtered-comparison">
<h3>Raw vs FISD-filtered comparison<a class="headerlink" href="#raw-vs-fisd-filtered-comparison" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fisd_filtered</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span>
    <span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;trace_enhanced_fisd&quot;</span> <span class="o">/</span> <span class="s2">&quot;**/*.parquet&quot;</span><span class="p">,</span>
    <span class="n">hive_partitioning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2024</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">n_fisd_filtered</span> <span class="o">=</span> <span class="n">fisd_filtered</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="n">n_cusips_raw</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">n_unique</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">n_cusips_fisd</span> <span class="o">=</span> <span class="n">fisd_filtered</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cusip_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">n_unique</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">30s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Rows&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Unique CUSIPs&#39;</span><span class="si">:</span><span class="s2">&gt;15s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Raw TRACE Enhanced (Jan 24)&#39;</span><span class="si">:</span><span class="s2">30s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">n_raw</span><span class="si">:</span><span class="s2">&gt;12,</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">n_cusips_raw</span><span class="si">:</span><span class="s2">&gt;15,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;After FISD filter&#39;</span><span class="si">:</span><span class="s2">30s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">n_fisd_filtered</span><span class="si">:</span><span class="s2">&gt;12,</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">n_cusips_fisd</span><span class="si">:</span><span class="s2">&gt;15,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Dropped&#39;</span><span class="si">:</span><span class="s2">30s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">n_raw</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_fisd_filtered</span><span class="si">:</span><span class="s2">&gt;12,</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">n_cusips_raw</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_cusips_fisd</span><span class="si">:</span><span class="s2">&gt;15,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_raw</span> <span class="o">-</span> <span class="n">n_fisd_filtered</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_raw</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FISD filter removes </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of raw trade records.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                       Rows   Unique CUSIPs
Raw TRACE Enhanced (Jan 24)       3,768,457          29,998
After FISD filter                 2,792,786          11,940
Dropped                             975,671          18,058

FISD filter removes 25.9% of raw trade records.
</pre></div>
</div>
</div>
</div>
<p>The FISD filter removes trades in non-standard bonds (government, MBS, ABS,
municipals, convertibles, etc.) that are not the focus of corporate bond
research.</p>
</section>
</section>
<hr class="docutils" />
<section id="stage-0-dick-nielsen-cleaning-pipeline">
<h2>5. Stage 0: Dick-Nielsen Cleaning Pipeline<a class="headerlink" href="#stage-0-dick-nielsen-cleaning-pipeline" title="Link to this heading">#</a></h2>
<p>Stage 0 applies <strong>11 sequential filters</strong> to the FISD-filtered intraday data
and ends with daily aggregation. The implementation lives in
<code class="docutils literal notranslate"><span class="pre">src/stage0/clean_trace_local.py</span></code> (function <code class="docutils literal notranslate"><span class="pre">_apply_filter_chain</span></code>).</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>#</p></th>
<th class="head"><p>Filter</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p><strong>Dick-Nielsen</strong></p></td>
<td><p>Match and remove cancellations, corrections, reversals; remove agency inter-dealer duplicates</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p><strong>Decimal-shift corrector</strong></p></td>
<td><p>Fix prices that are 10x, 100x, 0.1x, or 0.01x off from neighboring trades</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p><strong>Trading time</strong></p></td>
<td><p>Restrict to market hours (disabled by default)</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p><strong>Trading calendar</strong></p></td>
<td><p>Remove trades on non-trading days (weekends, holidays per NYSE calendar)</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p><strong>Price filter</strong></p></td>
<td><p>Remove trades with price &lt;= 0 or &gt; $1,000</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p><strong>Volume filter</strong></p></td>
<td><p>Remove trades with dollar volume &lt; $10,000</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p><strong>Bounce-back filter</strong></p></td>
<td><p>Detect erroneous price spikes that revert within a few trades</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p><strong>Yield-price consistency</strong></p></td>
<td><p>Remove rows where the yield field equals the price field (data entry error)</p></td>
</tr>
<tr class="row-even"><td><p>9</p></td>
<td><p><strong>Amount outstanding</strong></p></td>
<td><p>Remove trades with volume &gt; 50% of offering amount</p></td>
</tr>
<tr class="row-odd"><td><p>10</p></td>
<td><p><strong>Execution vs maturity</strong></p></td>
<td><p>Remove trades executed after the bond‚Äôs maturity date</p></td>
</tr>
<tr class="row-even"><td><p>11</p></td>
<td><p><strong>Initial price error</strong></p></td>
<td><p>Flag extreme price jumps in the first few trades per CUSIP</p></td>
</tr>
</tbody>
</table>
</div>
<p>After all filters, intraday trades are <strong>aggregated to one row per
(cusip_id, date)</strong> with equal-weighted price (<code class="docutils literal notranslate"><span class="pre">prc_ew</span></code>), volume-weighted
price (<code class="docutils literal notranslate"><span class="pre">prc_vw</span></code>), first/last prices, trade count, and total volume.</p>
<section id="stage-0-output-the-daily-panel">
<h3>Stage 0 output: the daily panel<a class="headerlink" href="#stage-0-output-the-daily-panel" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s0</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span>
    <span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;stage0&quot;</span> <span class="o">/</span> <span class="s2">&quot;enhanced&quot;</span> <span class="o">/</span> <span class="s2">&quot;year=*/month=*/data.parquet&quot;</span><span class="p">,</span>
    <span class="n">hive_partitioning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">s0_jan</span> <span class="o">=</span> <span class="n">s0</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2024</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">n_s0</span> <span class="o">=</span> <span class="n">s0_jan</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">s0_cols</span> <span class="o">=</span> <span class="n">s0</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage 0 Enhanced (Jan 2024) -- Rows: </span><span class="si">{</span><span class="n">n_s0</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> (one row per cusip-day)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">s0_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">s0_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Stage 0 Enhanced (Jan 2024) -- Rows: 149,135 (one row per cusip-day)
Columns (23): [&#39;cusip_id&#39;, &#39;trd_exctn_dt&#39;, &#39;prc_ew&#39;, &#39;prc_vw&#39;, &#39;prc_vw_par&#39;, &#39;prc_first&#39;, &#39;prc_last&#39;, &#39;prc_hi&#39;, &#39;prc_lo&#39;, &#39;trade_count&#39;, &#39;time_ew&#39;, &#39;time_last&#39;, &#39;qvolume&#39;, &#39;dvolume&#39;, &#39;prc_bid&#39;, &#39;bid_last&#39;, &#39;bid_time_ew&#39;, &#39;bid_time_last&#39;, &#39;prc_ask&#39;, &#39;bid_count&#39;, &#39;ask_count&#39;, &#39;year&#39;, &#39;month&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>Example rows<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s0_jan</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 23)</small><table border="1" class="dataframe"><thead><tr><th>cusip_id</th><th>trd_exctn_dt</th><th>prc_ew</th><th>prc_vw</th><th>prc_vw_par</th><th>prc_first</th><th>prc_last</th><th>prc_hi</th><th>prc_lo</th><th>trade_count</th><th>time_ew</th><th>time_last</th><th>qvolume</th><th>dvolume</th><th>prc_bid</th><th>bid_last</th><th>bid_time_ew</th><th>bid_time_last</th><th>prc_ask</th><th>bid_count</th><th>ask_count</th><th>year</th><th>month</th></tr><tr><td>str</td><td>datetime[ms]</td><td>f64</td><td>f64</td><td>f64</td><td>f64</td><td>f64</td><td>f64</td><td>f64</td><td>i64</td><td>f64</td><td>i32</td><td>f64</td><td>f64</td><td>f64</td><td>f64</td><td>f64</td><td>i32</td><td>f64</td><td>f64</td><td>f64</td><td>i64</td><td>i64</td></tr></thead><tbody><tr><td>&quot;00037BAC6&quot;</td><td>2024-01-16 00:00:00</td><td>89.9055</td><td>89.90575</td><td>89.90575</td><td>89.905</td><td>89.906</td><td>89.906</td><td>89.905</td><td>4</td><td>57610.0</td><td>57610</td><td>0.16</td><td>0.1438492</td><td>null</td><td>null</td><td>null</td><td>null</td><td>89.90575</td><td>null</td><td>2.0</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAC6&quot;</td><td>2024-01-24 00:00:00</td><td>89.658</td><td>89.658</td><td>89.658</td><td>89.658</td><td>89.658</td><td>89.658</td><td>89.658</td><td>1</td><td>43883.0</td><td>43883</td><td>1.0</td><td>0.89658</td><td>null</td><td>null</td><td>null</td><td>null</td><td>89.658</td><td>null</td><td>1.0</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAC6&quot;</td><td>2024-01-30 00:00:00</td><td>90.477</td><td>90.477</td><td>90.477</td><td>90.477</td><td>90.477</td><td>90.477</td><td>90.477</td><td>1</td><td>57628.0</td><td>57628</td><td>0.669</td><td>0.605291</td><td>90.477</td><td>90.477</td><td>57628.0</td><td>57628</td><td>null</td><td>1.0</td><td>0.0</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAC6&quot;</td><td>2024-01-31 00:00:00</td><td>91.183667</td><td>91.084617</td><td>91.084437</td><td>91.276</td><td>90.999</td><td>91.276</td><td>90.999</td><td>3</td><td>41617.333333</td><td>44742</td><td>4.338</td><td>3.951243</td><td>null</td><td>null</td><td>null</td><td>null</td><td>90.999</td><td>null</td><td>1.0</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAF9&quot;</td><td>2024-01-02 00:00:00</td><td>98.217</td><td>98.217</td><td>98.217</td><td>98.217</td><td>98.217</td><td>98.217</td><td>98.217</td><td>1</td><td>41319.0</td><td>41319</td><td>0.26</td><td>0.2553642</td><td>null</td><td>null</td><td>null</td><td>null</td><td>98.217</td><td>null</td><td>1.0</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAF9&quot;</td><td>2024-01-03 00:00:00</td><td>98.611</td><td>98.611</td><td>98.611</td><td>98.611</td><td>98.611</td><td>98.611</td><td>98.611</td><td>2</td><td>57612.0</td><td>57612</td><td>2.0</td><td>1.97222</td><td>null</td><td>null</td><td>null</td><td>null</td><td>98.611</td><td>null</td><td>1.0</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAF9&quot;</td><td>2024-01-24 00:00:00</td><td>97.731</td><td>97.731</td><td>97.731</td><td>97.731</td><td>97.731</td><td>97.731</td><td>97.731</td><td>1</td><td>51328.0</td><td>51328</td><td>0.075</td><td>0.073298</td><td>null</td><td>null</td><td>null</td><td>null</td><td>97.731</td><td>null</td><td>1.0</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAF9&quot;</td><td>2024-01-29 00:00:00</td><td>98.303</td><td>98.303</td><td>98.303</td><td>98.303</td><td>98.303</td><td>98.303</td><td>98.303</td><td>1</td><td>57635.0</td><td>57635</td><td>0.1</td><td>0.098303</td><td>98.303</td><td>98.303</td><td>57635.0</td><td>57635</td><td>null</td><td>1.0</td><td>0.0</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAF9&quot;</td><td>2024-01-30 00:00:00</td><td>98.14664</td><td>98.146641</td><td>98.14664</td><td>98.13883</td><td>98.15445</td><td>98.15445</td><td>98.13883</td><td>2</td><td>48722.0</td><td>48722</td><td>0.18</td><td>0.176664</td><td>null</td><td>null</td><td>null</td><td>null</td><td>null</td><td>null</td><td>null</td><td>2024</td><td>1</td></tr><tr><td>&quot;00037BAF9&quot;</td><td>2024-01-31 00:00:00</td><td>98.489</td><td>98.394401</td><td>98.394373</td><td>98.597</td><td>98.381</td><td>98.597</td><td>98.381</td><td>2</td><td>60076.5</td><td>62503</td><td>0.533</td><td>0.524442</td><td>98.394401</td><td>98.381</td><td>60076.5</td><td>62503</td><td>null</td><td>2.0</td><td>0.0</td><td>2024</td><td>1</td></tr></tbody></table></div></div></div>
</div>
</section>
<section id="data-reduction-through-the-pipeline">
<h3>Data reduction through the pipeline<a class="headerlink" href="#data-reduction-through-the-pipeline" title="Link to this heading">#</a></h3>
<p>The table below shows how row counts change at each stage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raw_both</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span>
    <span class="n">PULL_DIR</span> <span class="o">/</span> <span class="s2">&quot;trace_enhanced&quot;</span> <span class="o">/</span> <span class="s2">&quot;**/*.parquet&quot;</span><span class="p">,</span>
    <span class="n">hive_partitioning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">missing_columns</span><span class="o">=</span><span class="s2">&quot;insert&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="n">fisd_both</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span>
    <span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;trace_enhanced_fisd&quot;</span> <span class="o">/</span> <span class="s2">&quot;**/*.parquet&quot;</span><span class="p">,</span>
    <span class="n">hive_partitioning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="n">s0_both</span> <span class="o">=</span> <span class="n">s0</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="n">summary</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;Stage&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Raw TRACE Enhanced&quot;</span><span class="p">,</span>
        <span class="s2">&quot;After FISD filter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Stage 0 (daily panel)&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;Rows&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">raw_both</span><span class="p">,</span> <span class="n">fisd_both</span><span class="p">,</span> <span class="n">s0_both</span><span class="p">],</span>
    <span class="s2">&quot;Granularity&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;intraday trade reports&quot;</span><span class="p">,</span>
        <span class="s2">&quot;intraday trade reports&quot;</span><span class="p">,</span>
        <span class="s2">&quot;one row per cusip-day&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">})</span>
<span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (3, 3)</small><table border="1" class="dataframe"><thead><tr><th>Stage</th><th>Rows</th><th>Granularity</th></tr><tr><td>str</td><td>i64</td><td>str</td></tr></thead><tbody><tr><td>&quot;Raw TRACE Enhanced&quot;</td><td>423792457</td><td>&quot;intraday trade reports&quot;</td></tr><tr><td>&quot;After FISD filter&quot;</td><td>329061163</td><td>&quot;intraday trade reports&quot;</td></tr><tr><td>&quot;Stage 0 (daily panel)&quot;</td><td>286454</td><td>&quot;one row per cusip-day&quot;</td></tr></tbody></table></div></div></div>
</div>
<p>The dramatic reduction from millions of intraday records to the daily panel
reflects both (a) removal of erroneous/duplicate records and (b) daily
aggregation.</p>
</section>
<section id="daily-trade-counts-raw-vs-cleaned">
<h3>Daily trade counts: raw vs cleaned<a class="headerlink" href="#daily-trade-counts-raw-vs-cleaned" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raw_daily</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span>
        <span class="n">PULL_DIR</span> <span class="o">/</span> <span class="s2">&quot;trace_enhanced&quot;</span> <span class="o">/</span> <span class="s2">&quot;**/*.parquet&quot;</span><span class="p">,</span>
        <span class="n">hive_partitioning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">missing_columns</span><span class="o">=</span><span class="s2">&quot;insert&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trc_st&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2024</span><span class="p">,</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n_trades&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">s0_daily</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s0</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2024</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trade_count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n_trades&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">raw_dates</span> <span class="o">=</span> <span class="n">raw_daily</span><span class="p">[</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="n">s0_dates</span> <span class="o">=</span> <span class="n">s0_daily</span><span class="p">[</span><span class="s2">&quot;trd_exctn_dt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">raw_dates</span><span class="p">,</span>
    <span class="n">raw_daily</span><span class="p">[</span><span class="s2">&quot;n_trades&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trade reports&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raw TRACE (status=T records only)&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">s0_dates</span><span class="p">,</span>
    <span class="n">s0_daily</span><span class="p">[</span><span class="s2">&quot;n_trades&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trades (after cleaning)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Stage 0 (cleaned trade count)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">_ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">WeekdayLocator</span><span class="p">(</span><span class="n">byweekday</span><span class="o">=</span><span class="n">mdates</span><span class="o">.</span><span class="n">MO</span><span class="p">))</span>
    <span class="n">_ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%b </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s2">&quot;Daily trade volume: raw vs cleaned (Jan--Feb 2024)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/99eb0fe7a23ec26bb1260e4177b1446bc1d30dd0ae34ecf4a295f00c5816a89d.png" src="../_images/99eb0fe7a23ec26bb1260e4177b1446bc1d30dd0ae34ecf4a295f00c5816a89d.png" />
</div>
</div>
</section>
<section id="price-distributions-raw-vs-cleaned">
<h3>Price distributions: raw vs cleaned<a class="headerlink" href="#price-distributions-raw-vs-cleaned" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raw_pr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span>
        <span class="n">PULL_DIR</span> <span class="o">/</span> <span class="s2">&quot;trace_enhanced&quot;</span> <span class="o">/</span> <span class="s2">&quot;**/*.parquet&quot;</span><span class="p">,</span>
        <span class="n">hive_partitioning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">missing_columns</span><span class="o">=</span><span class="s2">&quot;insert&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trc_st&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2024</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;rptd_pr&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="s2">&quot;rptd_pr&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">s0_pr</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s0_jan</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;prc_ew&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="s2">&quot;prc_ew&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">raw_pr</span><span class="p">[(</span><span class="n">raw_pr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_pr</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">)],</span>
    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raw (T records)&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">s0_pr</span><span class="p">[(</span><span class="n">s0_pr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s0_pr</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">)],</span>
    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stage 0 (prc_ew)&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Price ($)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Price distribution: raw intraday trades vs Stage 0 daily EW price (Jan 2024)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0c484dec961fbaeb952d93f9f7373afe863a25b2b4ce55177a37b4dfe470c1a8.png" src="../_images/0c484dec961fbaeb952d93f9f7373afe863a25b2b4ce55177a37b4dfe470c1a8.png" />
</div>
</div>
<p>The cleaned distribution is tighter, with extreme tails removed. Daily
aggregation (averaging across trades) further reduces noise.</p>
</section>
<section id="equal-weighted-vs-volume-weighted-prices">
<h3>Equal-weighted vs volume-weighted prices<a class="headerlink" href="#equal-weighted-vs-volume-weighted-prices" title="Link to this heading">#</a></h3>
<p>The Stage 0 panel provides both <code class="docutils literal notranslate"><span class="pre">prc_ew</span></code> (equal-weighted average across
all intraday trades) and <code class="docutils literal notranslate"><span class="pre">prc_vw</span></code> (volume-weighted). For research,
<strong>volume-weighted prices down-weight small ‚Äúnoise‚Äù trades</strong>, providing
a better estimate of the bond‚Äôs true price.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s0_prices</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s0_jan</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;prc_ew&quot;</span><span class="p">,</span> <span class="s2">&quot;prc_vw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">s0_prices</span><span class="p">[</span><span class="s2">&quot;prc_ew&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="n">s0_prices</span><span class="p">[</span><span class="s2">&quot;prc_vw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;EW price ($)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;VW price ($)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Equal-weighted vs volume-weighted daily prices (Jan 2024)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s0_prices</span><span class="p">[</span><span class="s2">&quot;prc_ew&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">s0_prices</span><span class="p">[</span><span class="s2">&quot;prc_vw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean |EW - VW| difference:   $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Median |EW - VW| difference: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95th pctile |EW - VW|:       $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="mi">95</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/39255dc97e4bc74c176fd5963b9098135e29c01c15887de9bbff14d6842ccb7b.png" src="../_images/39255dc97e4bc74c176fd5963b9098135e29c01c15887de9bbff14d6842ccb7b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean |EW - VW| difference:   $0.0629
Median |EW - VW| difference: $0.0220
95th pctile |EW - VW|:       $0.2612
</pre></div>
</div>
</div>
</div>
</section>
<section id="market-microstructure-noise-in-context">
<h3>Market microstructure noise in context<a class="headerlink" href="#market-microstructure-noise-in-context" title="Link to this heading">#</a></h3>
<p>Most points lie on the 45-degree line, but the divergences‚Äîwhere
small trades transact at systematically different prices than large
trades‚Äîare precisely the <strong>market microstructure noise (MMN)</strong> that
Dickerson, Robotti, and Rossetti (2024) warn about.</p>
<p>Key implications from DRR (2024):</p>
<ul class="simple">
<li><p>Even after cleaning, daily prices contain MMN because individual trades
include bid-ask bounce and dealer markups.</p></li>
<li><p>The EW price gives equal weight to a <span class="math notranslate nohighlight">\(10K retail trade and a \)</span>5M
institutional block‚Äîyet these trades occur at systematically different
prices.</p></li>
<li><p>The VW price partially mitigates this, but does not fully remove MMN.</p></li>
<li><p>Using noisy prices as signals for portfolio sorts creates <strong>spurious
predictability</strong>. For example, short-term reversal premia of 0.90%/month
vanish after MMN correction.</p></li>
<li><p>Volume-weighted prices (<code class="docutils literal notranslate"><span class="pre">prc_vw</span></code>) should be preferred over <code class="docutils literal notranslate"><span class="pre">prc_ew</span></code>
when computing returns for research.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="stage-1-enrichment">
<h2>6. Stage 1: Enrichment<a class="headerlink" href="#stage-1-enrichment" title="Link to this heading">#</a></h2>
<p>Stage 1 takes the clean daily panel from Stage 0 and enriches it with
bond analytics and reference data:</p>
<p><strong>Analytics (computed via QuantLib):</strong></p>
<ul class="simple">
<li><p>Accrued interest (to convert between clean and dirty prices)</p></li>
<li><p>Yield to maturity (YTM)</p></li>
<li><p>Modified duration and Macaulay duration</p></li>
<li><p>Convexity</p></li>
<li><p>Credit spread (bond yield minus duration-matched Liu-Wu Treasury
zero-coupon yield)</p></li>
</ul>
<p><strong>Merged reference data:</strong></p>
<ul class="simple">
<li><p>FISD bond characteristics (coupon, maturity, offering amount, callable flag)</p></li>
<li><p>Credit ratings from Moody‚Äôs and S&amp;P (as-of, forward-filled)</p></li>
<li><p>Fama-French 17/30 industry classification (via SIC codes)</p></li>
<li><p>Equity identifiers (PERMNO, PERMCO, GVKEY) via the OBAP bond-firm linker</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>

<span class="n">s1_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;stage1&quot;</span> <span class="o">/</span> <span class="s2">&quot;stage1_*.parquet&quot;</span><span class="p">)))</span>
<span class="n">s1_path</span> <span class="o">=</span> <span class="n">s1_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># most recent</span>
<span class="n">s1</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">s1_path</span><span class="p">)</span>
<span class="n">n_s1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">cols_s1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage 1 (</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">s1_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">) -- Rows: </span><span class="si">{</span><span class="n">n_s1</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">  |  Columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cols_s1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns: </span><span class="si">{</span><span class="n">cols_s1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Stage 1 (stage1_20260223.parquet) -- Rows: 333,901  |  Columns: 43
Columns: [&#39;cusip_id&#39;, &#39;permno&#39;, &#39;permco&#39;, &#39;gvkey&#39;, &#39;trd_exctn_dt&#39;, &#39;pr&#39;, &#39;prfull&#39;, &#39;acclast&#39;, &#39;accpmt&#39;, &#39;accall&#39;, &#39;ytm&#39;, &#39;mod_dur&#39;, &#39;mac_dur&#39;, &#39;convexity&#39;, &#39;bond_maturity&#39;, &#39;credit_spread&#39;, &#39;prc_ew&#39;, &#39;prc_vw_par&#39;, &#39;prc_first&#39;, &#39;prc_last&#39;, &#39;prc_hi&#39;, &#39;prc_lo&#39;, &#39;trade_count&#39;, &#39;time_ew&#39;, &#39;time_last&#39;, &#39;qvolume&#39;, &#39;dvolume&#39;, &#39;prc_bid&#39;, &#39;bid_last&#39;, &#39;bid_time_ew&#39;, &#39;bid_time_last&#39;, &#39;prc_ask&#39;, &#39;bid_count&#39;, &#39;ask_count&#39;, &#39;db_type&#39;, &#39;ff17num&#39;, &#39;ff30num&#39;, &#39;bond_age&#39;, &#39;bond_amt_outstanding&#39;, &#39;sp_rating&#39;, &#39;mdy_rating&#39;, &#39;spc_rating&#39;, &#39;mdc_rating&#39;]
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h3>Example rows<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 43)</small><table border="1" class="dataframe"><thead><tr><th>cusip_id</th><th>permno</th><th>permco</th><th>gvkey</th><th>trd_exctn_dt</th><th>pr</th><th>prfull</th><th>acclast</th><th>accpmt</th><th>accall</th><th>ytm</th><th>mod_dur</th><th>mac_dur</th><th>convexity</th><th>bond_maturity</th><th>credit_spread</th><th>prc_ew</th><th>prc_vw_par</th><th>prc_first</th><th>prc_last</th><th>prc_hi</th><th>prc_lo</th><th>trade_count</th><th>time_ew</th><th>time_last</th><th>qvolume</th><th>dvolume</th><th>prc_bid</th><th>bid_last</th><th>bid_time_ew</th><th>bid_time_last</th><th>prc_ask</th><th>bid_count</th><th>ask_count</th><th>db_type</th><th>ff17num</th><th>ff30num</th><th>bond_age</th><th>bond_amt_outstanding</th><th>sp_rating</th><th>mdy_rating</th><th>spc_rating</th><th>mdc_rating</th></tr><tr><td>cat</td><td>i32</td><td>i32</td><td>i32</td><td>datetime[ns]</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>f64</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>f64</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>i16</td><td>f32</td><td>i32</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>f32</td><td>i16</td><td>i16</td><td>i8</td><td>i8</td><td>i8</td><td>f32</td><td>i64</td><td>i8</td><td>i8</td><td>i8</td><td>i8</td></tr></thead><tbody><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-12 00:00:00</td><td>99.644699</td><td>99.64473</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.084359</td><td>4.018</td><td>4.187</td><td>19.893</td><td>5.01</td><td>0.046275</td><td>99.662743</td><td>99.64463</td><td>99.75</td><td>99.5</td><td>100.080002</td><td>99.5</td><td>47</td><td>32683.873047</td><td>55470</td><td>43.099998</td><td>42.946835</td><td>99.606499</td><td>99.5</td><td>33551.53125</td><td>55470.0</td><td>99.813789</td><td>17</td><td>5</td><td>3</td><td>16</td><td>29</td><td>0.002738</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-16 00:00:00</td><td>98.920601</td><td>98.920624</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.086234</td><td>4.008</td><td>4.181</td><td>19.813</td><td>4.999</td><td>0.047138</td><td>98.936501</td><td>98.919998</td><td>99.5</td><td>98.949997</td><td>99.5</td><td>98.625</td><td>20</td><td>45762.851562</td><td>55865</td><td>17.25</td><td>17.0637</td><td>98.970909</td><td>98.6875</td><td>39102.855469</td><td>52321.0</td><td>99.028244</td><td>7</td><td>6</td><td>3</td><td>16</td><td>29</td><td>0.013689</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-17 00:00:00</td><td>96.936501</td><td>96.936493</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.091364</td><td>3.986</td><td>4.168</td><td>19.632999</td><td>4.997</td><td>0.051367</td><td>96.930786</td><td>96.930786</td><td>98.030998</td><td>96.0</td><td>98.030998</td><td>96.0</td><td>14</td><td>51371.070312</td><td>63216</td><td>14.0</td><td>13.57031</td><td>97.00193</td><td>96.75</td><td>49492.5</td><td>53847.0</td><td>96.787689</td><td>4</td><td>9</td><td>3</td><td>16</td><td>29</td><td>0.016427</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-18 00:00:00</td><td>97.560303</td><td>97.56031</td><td>0.0</td><td>0.0</td><td>0.0</td><td>0.089939</td><td>3.983</td><td>4.163</td><td>19.608999</td><td>4.994</td><td>0.049759</td><td>97.559998</td><td>97.559998</td><td>97.625</td><td>97.25</td><td>97.75</td><td>97.25</td><td>5</td><td>46109.199219</td><td>54864</td><td>5.0</td><td>4.878</td><td>97.45858</td><td>97.25</td><td>46403.332031</td><td>54864.0</td><td>97.712517</td><td>3</td><td>2</td><td>3</td><td>16</td><td>29</td><td>0.019165</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-19 00:00:00</td><td>97.666901</td><td>97.690155</td><td>0.023264</td><td>0.0</td><td>0.023264</td><td>0.089667</td><td>3.982</td><td>4.16</td><td>19.594999</td><td>4.991</td><td>0.04948</td><td>97.800003</td><td>97.666664</td><td>97.599998</td><td>98.0</td><td>98.0</td><td>97.599998</td><td>2</td><td>53709.0</td><td>54910</td><td>1.2</td><td>1.172</td><td>null</td><td>null</td><td>null</td><td>null</td><td>97.666893</td><td>null</td><td>2</td><td>3</td><td>16</td><td>29</td><td>0.021903</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-22 00:00:00</td><td>97.141998</td><td>97.188507</td><td>0.046528</td><td>0.0</td><td>0.046528</td><td>0.091023</td><td>3.974</td><td>4.155</td><td>19.531</td><td>4.983</td><td>0.051037</td><td>97.141846</td><td>97.141846</td><td>97.195</td><td>97.5</td><td>97.5</td><td>97.0</td><td>19</td><td>53547.632812</td><td>59996</td><td>19.0</td><td>18.456949</td><td>97.123344</td><td>97.375</td><td>53735.855469</td><td>59911.0</td><td>97.267708</td><td>7</td><td>4</td><td>3</td><td>16</td><td>29</td><td>0.030116</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-23 00:00:00</td><td>96.408501</td><td>96.478279</td><td>0.069792</td><td>0.0</td><td>0.069792</td><td>0.092933</td><td>3.964</td><td>4.148</td><td>19.450001</td><td>4.98</td><td>0.052799</td><td>96.372002</td><td>96.408134</td><td>96.75</td><td>96.25</td><td>96.75</td><td>96.223999</td><td>7</td><td>53864.144531</td><td>60691</td><td>5.5</td><td>5.302447</td><td>96.402405</td><td>96.25</td><td>54821.75</td><td>60691.0</td><td>96.375</td><td>4</td><td>1</td><td>3</td><td>16</td><td>29</td><td>0.032854</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-24 00:00:00</td><td>95.909401</td><td>96.002426</td><td>0.093056</td><td>0.0</td><td>0.093056</td><td>0.094246</td><td>3.957</td><td>4.143</td><td>19.388</td><td>4.977</td><td>0.05366</td><td>95.783333</td><td>95.907265</td><td>96.808998</td><td>94.882004</td><td>96.808998</td><td>94.859001</td><td>6</td><td>44907.5</td><td>55726</td><td>3.6</td><td>3.452662</td><td>95.673523</td><td>94.859001</td><td>49877.0</td><td>55726.0</td><td>96.169693</td><td>2</td><td>3</td><td>3</td><td>16</td><td>29</td><td>0.035592</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-25 00:00:00</td><td>95.077301</td><td>95.240166</td><td>0.162847</td><td>0.0</td><td>0.162847</td><td>0.096461</td><td>3.94</td><td>4.131</td><td>19.254999</td><td>4.975</td><td>0.056679</td><td>95.077003</td><td>95.077003</td><td>95.25</td><td>94.903999</td><td>95.25</td><td>94.903999</td><td>2</td><td>40048.5</td><td>47720</td><td>2.0</td><td>1.90154</td><td>95.25</td><td>95.25</td><td>32377.0</td><td>32377.0</td><td>null</td><td>1</td><td>0</td><td>3</td><td>16</td><td>29</td><td>0.03833</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr><tr><td>&quot;00033GAA3&quot;</td><td>null</td><td>null</td><td>null</td><td>2024-01-26 00:00:00</td><td>95.041801</td><td>95.227921</td><td>0.186111</td><td>0.0</td><td>0.186111</td><td>0.096561</td><td>3.937</td><td>4.128</td><td>19.229</td><td>4.972</td><td>0.05642</td><td>95.041664</td><td>95.041664</td><td>95.125</td><td>95.125</td><td>95.125</td><td>94.875</td><td>3</td><td>48799.332031</td><td>54143</td><td>3.0</td><td>2.85125</td><td>94.875</td><td>94.875</td><td>47008.0</td><td>47008.0</td><td>95.125</td><td>1</td><td>2</td><td>3</td><td>16</td><td>29</td><td>0.041068</td><td>525000</td><td>14</td><td>15</td><td>14</td><td>15</td></tr></tbody></table></div></div></div>
</div>
</section>
<section id="credit-spread-distribution">
<h3>Credit spread distribution<a class="headerlink" href="#credit-spread-distribution" title="Link to this heading">#</a></h3>
<p>The credit spread is the yield premium a corporate bond pays over a
duration-matched Treasury zero-coupon yield. It reflects credit risk,
liquidity risk, and other bond-specific factors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cs</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">median_cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">median_cs</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Median: </span><span class="si">{</span><span class="n">median_cs</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pp&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Credit spread (percentage points)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Credit spread distribution (Stage 1)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e463264968d0f6e11c56d8e1c9ac147bb059cc4d8d9575cd1c28d358ea47b81f.png" src="../_images/e463264968d0f6e11c56d8e1c9ac147bb059cc4d8d9575cd1c28d358ea47b81f.png" />
</div>
</div>
</section>
<section id="modified-duration-by-credit-rating">
<h3>Modified duration by credit rating<a class="headerlink" href="#modified-duration-by-credit-rating" title="Link to this heading">#</a></h3>
<p>Investment-grade bonds (AAA through BBB) tend to have longer duration
because they carry lower default risk and can issue at longer maturities.
High-yield bonds (BB and below) tend to have shorter duration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s1_dur</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mod_dur&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sp_rating&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mod_dur&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mod_dur&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sp_rating&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;mod_dur&quot;</span><span class="p">,</span> <span class="s2">&quot;sp_rating&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_rating_bucket</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;AAA/AA&quot;</span>
    <span class="k">elif</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;A&quot;</span>
    <span class="k">elif</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;BBB&quot;</span>
    <span class="k">elif</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;BB/B&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CCC &amp; below&quot;</span>


<span class="n">s1_dur_pd</span> <span class="o">=</span> <span class="n">s1_dur</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="n">s1_dur_pd</span><span class="p">[</span><span class="s2">&quot;rating_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s1_dur_pd</span><span class="p">[</span><span class="s2">&quot;sp_rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_rating_bucket</span><span class="p">)</span>

<span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AAA/AA&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;BBB&quot;</span><span class="p">,</span> <span class="s2">&quot;BB/B&quot;</span><span class="p">,</span> <span class="s2">&quot;CCC &amp; below&quot;</span><span class="p">]</span>
<span class="n">data_by_group</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">s1_dur_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s1_dur_pd</span><span class="p">[</span><span class="s2">&quot;rating_group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">,</span> <span class="s2">&quot;mod_dur&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">order</span>
<span class="p">]</span>
<span class="c1"># Only keep groups with data</span>
<span class="n">valid</span> <span class="o">=</span> <span class="p">[(</span><span class="n">g</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">data_by_group</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">order_valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">]</span>
<span class="n">data_valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">bp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data_valid</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">order_valid</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">box_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#4c72b0&quot;</span><span class="p">,</span> <span class="s2">&quot;#55a868&quot;</span><span class="p">,</span> <span class="s2">&quot;#c44e52&quot;</span><span class="p">,</span> <span class="s2">&quot;#8172b2&quot;</span><span class="p">,</span> <span class="s2">&quot;#ccb974&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">patch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]):</span>
    <span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">box_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">box_colors</span><span class="p">)])</span>
    <span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;S&amp;P rating group&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Modified duration (years)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Modified duration by credit rating (Stage 1)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/l3/tj6vb0ld2ys1h939jz0qrfrh0000gn/T/ipykernel_93385/3343011909.py:41: MatplotlibDeprecationWarning: The &#39;labels&#39; parameter of boxplot() has been renamed &#39;tick_labels&#39; since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  bp = ax.boxplot(data_valid, labels=order_valid, patch_artist=True, showfliers=False)
</pre></div>
</div>
<img alt="../_images/24516082c9a3530e6b45d162cd82883d53c0544894af12bfeb513fe86a455bdd.png" src="../_images/24516082c9a3530e6b45d162cd82883d53c0544894af12bfeb513fe86a455bdd.png" />
</div>
</div>
</section>
<section id="bond-age-vs-time-to-maturity">
<h3>Bond age vs time-to-maturity<a class="headerlink" href="#bond-age-vs-time-to-maturity" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s1_scatter</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bond_maturity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bond_age&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.20</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bond_maturity&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bond_maturity&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;bond_age&quot;</span><span class="p">,</span> <span class="s2">&quot;bond_maturity&quot;</span><span class="p">,</span> <span class="s2">&quot;credit_spread&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">50_000</span><span class="p">)</span>
    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">s1_scatter</span><span class="p">[</span><span class="s2">&quot;bond_age&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="n">s1_scatter</span><span class="p">[</span><span class="s2">&quot;bond_maturity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
    <span class="n">c</span><span class="o">=</span><span class="n">s1_scatter</span><span class="p">[</span><span class="s2">&quot;credit_spread&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdYlGn_r&quot;</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Credit spread (pp)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Bond age (years since issuance)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time to maturity (years)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Bond age vs maturity, colored by credit spread&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1725a99532e4f72f4d88585f7b18795c13ab037e5735a59591b078e5bee83e0a.png" src="../_images/1725a99532e4f72f4d88585f7b18795c13ab037e5735a59591b078e5bee83e0a.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="takeaways-and-best-practices">
<h2>7. Takeaways and Best Practices<a class="headerlink" href="#takeaways-and-best-practices" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Always clean TRACE data before computing returns.</strong> Raw data contains
cancellations, corrections, reversals, decimal-shift errors, and
bounce-back errors. Using uncleaned data biases return estimates.</p></li>
<li><p><strong>Use the FISD universe to restrict to standard US corporate bonds.</strong>
Mixing in government, muni, ABS, or MBS trades will contaminate your
sample.</p></li>
<li><p><strong>Prefer volume-weighted prices</strong> (<code class="docutils literal notranslate"><span class="pre">prc_vw</span></code>) over equal-weighted
(<code class="docutils literal notranslate"><span class="pre">prc_ew</span></code>) when computing returns. EW prices over-weight small, noisy
trades.</p></li>
<li><p><strong>Be aware of market microstructure noise.</strong> Even after cleaning,
daily prices contain bid-ask bounce and dealer markup noise
(Dickerson, Robotti, and Rossetti, 2024). Price-based signals
(e.g., short-term reversal) may be spuriously profitable.</p></li>
<li><p><strong>Avoid ex-post filtering.</strong> Do not condition your bond sample on
future price availability or forward-looking criteria. Use only
ex-ante filters with information available at portfolio formation
(Dickerson, Robotti, and Rossetti, 2024, 2026).</p></li>
<li><p><strong>Validate against known benchmarks.</strong> Compare your output to the
Open Bond Asset Pricing (OBAP) database for duration, convexity,
and credit spread validation.</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Dick-Nielsen, J. (2009). Liquidity biases in TRACE. <em>Journal of Fixed
Income</em>, 19(2), 43‚Äì55.</p></li>
<li><p>Dick-Nielsen, J. (2014). How to clean enhanced TRACE data. Working paper.</p></li>
<li><p>Dickerson, A., Robotti, C., and Rossetti, G. (2024). Common pitfalls in
the evaluation of corporate bond strategies. Available at SSRN:
<a class="reference external" href="https://ssrn.com/abstract=4575879">https://ssrn.com/abstract=4575879</a>.</p></li>
<li><p>Dickerson, A., Robotti, C., and Rossetti, G. (2026). The Corporate Bond
Factor Replication Crisis.</p></li>
</ul>
</section>
</section>

<div class="section ablog__blog_comments">
   
</div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="_01_data_sources_overview_ipynb.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Data Sources Overview</p>
      </div>
    </a>
    <a class="right-next"
       href="../subject_to_change_after_this_week.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">WARNING: Notes subject to change after this week</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-trace-and-why-does-cleaning-matter">1. What Is TRACE and Why Does Cleaning Matter?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-securities-does-trace-cover">What securities does TRACE cover?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-information-is-in-the-public-data">What information is in the public data?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-access">Data access</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-this-pipeline-exists-lessons-from-the-literature">Why this pipeline exists: lessons from the literature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pipeline-overview">Pipeline overview</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-sources-and-pipeline-overview">2. Data Sources and Pipeline Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#three-trace-feeds">Three TRACE feeds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fisd-reference-data-6-files">FISD reference data (6 files)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#liu-wu-treasury-yields">Liu-Wu Treasury yields</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fama-french-sic-codes">Fama-French SIC codes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#open-source-bond-asset-pricing-osbap-datasets">Open Source Bond Asset Pricing (OSBAP) datasets</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-trace-enhanced-data">3. Raw TRACE Enhanced Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-rows">Example rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trace-status-code-distribution">TRACE status code distribution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-price-distribution">Raw price distribution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-single-bonds-intraday-trades">A single bond‚Äôs intraday trades</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fisd-universe-filtering">4. FISD Universe Filtering</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-bonds-from-the-fisd-universe">Example bonds from the FISD universe</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-vs-fisd-filtered-comparison">Raw vs FISD-filtered comparison</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-0-dick-nielsen-cleaning-pipeline">5. Stage 0: Dick-Nielsen Cleaning Pipeline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-0-output-the-daily-panel">Stage 0 output: the daily panel</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Example rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-reduction-through-the-pipeline">Data reduction through the pipeline</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#daily-trade-counts-raw-vs-cleaned">Daily trade counts: raw vs cleaned</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#price-distributions-raw-vs-cleaned">Price distributions: raw vs cleaned</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#equal-weighted-vs-volume-weighted-prices">Equal-weighted vs volume-weighted prices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#market-microstructure-noise-in-context">Market microstructure noise in context</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-1-enrichment">6. Stage 1: Enrichment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Example rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#credit-spread-distribution">Credit spread distribution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modified-duration-by-credit-rating">Modified duration by credit rating</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bond-age-vs-time-to-maturity">Bond age vs time-to-maturity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#takeaways-and-best-practices">7. Takeaways and Best Practices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jeremiah Bejarano
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2026, Jeremiah Bejarano.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>